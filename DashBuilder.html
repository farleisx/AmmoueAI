<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AmmoueAI | Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #preview-frame { height: 100%; width: 100%; border: none; transition: all 0.3s ease; }
        #code-view { height: 100%; width: 100%; border: none; font-family: 'Fira Code', monospace; font-size: 13px; outline: none; resize: none; color: #a5d6ff; background: #0f1115; }
        
        /* Mobile Preview Mode */
        .mobile-view { width: 375px !important; height: 667px !important; margin: auto; border: 12px solid #374151 !important; border-radius: 32px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        
        /* Thinking Lines Animation */
        .thinking-line { font-size: 11px; color: #6b7280; margin-bottom: 4px; border-left: 2px solid #3b82f6; padding-left: 8px; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        
        .replit-input:focus-within { border-color: #3b82f6; }
        .img-preview-bubble { position: relative; width: 50px; height: 50px; border-radius: 6px; overflow: hidden; border: 1px solid #374151; }
        .remove-img-btn { position: absolute; top: -2px; right: -2px; background: #ef4444; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    </style>
</head>
<body class="bg-[#0f1115] text-gray-300 h-screen flex flex-col overflow-hidden">

    <nav class="border-b border-gray-800 px-4 py-2 flex justify-between items-center bg-[#161b22]">
        <div class="flex items-center gap-6">
            <span class="text-white font-bold tracking-tighter text-lg italic">AmmoueAI</span>
            
            <div class="bg-gray-800 p-1 rounded-md flex gap-1">
                <button id="show-preview" class="px-3 py-1 text-xs font-bold rounded bg-gray-700 text-white">Preview</button>
                <button id="show-code" class="px-3 py-1 text-xs font-bold rounded text-gray-400 hover:text-white">Code</button>
            </div>

            <div id="device-controls" class="flex items-center gap-3 border-l border-gray-700 pl-4">
                <button id="set-desktop" class="text-blue-400 hover:text-white transition"><i class="fa-solid fa-desktop"></i></button>
                <button id="set-mobile" class="text-gray-500 hover:text-white transition"><i class="fa-solid fa-mobile-screen-button"></i></button>
                <button id="open-new-tab" class="text-gray-500 hover:text-white transition ml-2" title="Open in new window"><i class="fa-solid fa-up-right-from-square"></i></button>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <button id="publish-btn" class="hidden text-xs bg-green-600 hover:bg-green-500 text-white px-4 py-1.5 rounded-md font-bold transition">Publish</button>
            <div id="user-info" class="hidden flex items-center gap-2">
                <img id="user-avatar" class="w-6 h-6 rounded-full border border-gray-600">
                <button id="logout-btn" class="text-xs hover:text-white">Sign Out</button>
            </div>
            <button id="login-btn" class="text-xs bg-white text-black px-3 py-1.5 rounded-md font-bold">Login</button>
        </div>
    </nav>

    <main class="flex-1 flex overflow-hidden">
        <aside class="w-[380px] border-r border-gray-800 bg-[#0f1115] p-4 flex flex-col">
            <div class="flex-1 overflow-y-auto space-y-4 pr-2">
                <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-widest">Builder</h2>
                
                <div class="replit-input bg-[#161b22] border border-gray-700 rounded-xl p-3 transition-all">
                    <div id="image-preview-container" class="flex flex-wrap gap-2 mb-2"></div>
                    <textarea id="user-prompt" class="w-full bg-transparent border-none outline-none text-white text-sm resize-none" placeholder="Describe your site..." rows="4"></textarea>
                    
                    <div class="flex justify-between items-center mt-2 border-t border-gray-800 pt-2">
                        <label for="image-upload" class="cursor-pointer text-gray-400 hover:text-blue-400 transition">
                            <i class="fa-solid fa-image text-lg"></i>
                            <input type="file" id="image-upload" class="hidden" accept="image/*" multiple>
                        </label>
                        <button id="generate-btn" class="bg-blue-600 hover:bg-blue-500 text-white w-8 h-8 rounded-lg flex items-center justify-center transition">
                            <span id="gen-icon">âœ¨</span>
                        </button>
                    </div>
                </div>

                <div id="thinking-console" class="space-y-1 bg-[#0a0c10] p-3 rounded-lg border border-gray-800 min-h-[100px] max-h-[250px] overflow-y-auto hidden">
                    <p class="text-[10px] text-blue-500 font-bold uppercase mb-2">AI System Logs</p>
                    <div id="logs-container"></div>
                </div>
            </div>

            <div id="deploy-section" class="hidden border-t border-gray-800 pt-4 space-y-3">
                <p class="text-[10px] font-bold text-gray-500 uppercase">Site Settings</p>
                <input id="site-slug" type="text" placeholder="project-name" class="w-full bg-[#161b22] border border-gray-700 rounded-lg p-2 text-xs outline-none focus:border-blue-500">
                <div id="live-url-box" class="hidden p-2 bg-green-500/10 border border-green-500/20 rounded text-center">
                    <a id="live-url" href="#" target="_blank" class="text-[10px] text-green-400 font-mono"></a>
                </div>
            </div>
        </aside>

        <section class="flex-1 bg-[#1c1f26] flex items-center justify-center relative overflow-hidden">
            <div id="preview-wrapper" class="w-full h-full transition-all duration-300">
                <div id="preview-container" class="w-full h-full">
                    <iframe id="preview-frame" class="bg-white"></iframe>
                </div>
                <div id="code-container" class="w-full h-full hidden">
                    <textarea id="code-view" readonly></textarea>
                </div>
            </div>
            
            <button id="stop-btn" class="hidden absolute bottom-6 z-50 bg-red-500 text-white px-4 py-2 rounded-full text-xs font-bold shadow-2xl hover:bg-red-600">
                <i class="fa-solid fa-stop mr-2"></i> Stop
            </button>
        </section>
    </main>

    <script type="module">
        import { auth, getUserPlan, autoSaveProject } from "./fire_prompt.js";
        import { GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

        let currentHtml = "";
        let currentProjectId = null;
        let abortController = null;
        let attachedImages = [];

        const genBtn = document.getElementById('generate-btn');
        const logsContainer = document.getElementById('logs-container');
        const consoleEl = document.getElementById('thinking-console');
        const frame = document.getElementById('preview-frame');

        // Thinking Lines Generator
        const logNotes = [
            "Analyzing user intent...",
            "Designing responsive layout structure...",
            "Injecting semantic HTML5 elements...",
            "Optimizing CSS flexbox/grid containers...",
            "Configuring color palette and typography...",
            "Adding interactive event listeners...",
            "Finalizing assets and components...",
            "Vetting accessibility standards..."
        ];

        function addLog(text) {
            const line = document.createElement('div');
            line.className = 'thinking-line';
            line.innerText = `> ${text}`;
            logsContainer.appendChild(line);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        /* ---------------- PREVIEW MODES ---------------- */
        document.getElementById('set-desktop').onclick = () => {
            frame.classList.remove('mobile-view');
            document.getElementById('set-desktop').className = 'text-blue-400';
            document.getElementById('set-mobile').className = 'text-gray-500';
        };

        document.getElementById('set-mobile').onclick = () => {
            frame.classList.add('mobile-view');
            document.getElementById('set-mobile').className = 'text-blue-400';
            document.getElementById('set-desktop').className = 'text-gray-500';
        };

        document.getElementById('open-new-tab').onclick = () => {
            const newTab = window.open('about:blank', '_blank');
            newTab.document.write(currentHtml);
            newTab.document.close();
        };

        /* ---------------- GENERATION ---------------- */
        genBtn.onclick = async () => {
            if (!auth.currentUser) return alert("Please Login");
            
            abortController = new AbortController();
            consoleEl.classList.remove('hidden');
            logsContainer.innerHTML = "";
            genBtn.classList.add('opacity-50', 'pointer-events-none');
            currentHtml = "";

            let logIndex = 0;
            const logInterval = setInterval(() => {
                if (logIndex < logNotes.length) addLog(logNotes[logIndex++]);
            }, 1500);

            try {
                const idToken = await auth.currentUser.getIdToken();
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}` },
                    body: JSON.stringify({ prompt: document.getElementById('user-prompt').value, images: attachedImages }),
                    signal: abortController.signal
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (!line.startsWith('data: ')) continue;
                        const raw = line.slice(6).trim();
                        if (raw === '[DONE]') break;
                        try {
                            const data = JSON.parse(raw);
                            if (data.text) {
                                currentHtml += data.text;
                                updatePreview(currentHtml);
                            }
                        } catch (e) {}
                    }
                }
                
                addLog("Project ready for deployment.");
                document.getElementById('deploy-section').classList.remove('hidden');
                document.getElementById('publish-btn').classList.remove('hidden');
            } catch (err) {
                addLog("Error: Generation interrupted.");
            } finally {
                clearInterval(logInterval);
                genBtn.classList.remove('opacity-50', 'pointer-events-none');
            }
        };

        function updatePreview(html) {
            const blob = new Blob([html], { type: 'text/html' });
            frame.src = URL.createObjectURL(blob);
            document.getElementById('code-view').value = html;
        }

        /* ---------------- PUBLISH ---------------- */
        document.getElementById('publish-btn').onclick = async () => {
            const slug = document.getElementById('site-slug').value;
            if(!slug) return alert("Please enter a project name first.");
            
            addLog(`Publishing to https://${slug}.vercel.app...`);
            // Call your /api/deploy logic here (similar to main.js in previous step)
        };

        /* ---------------- AUTH & IMAGE HELPERS (OMITTED FOR BREVITY, SAME AS BEFORE) ---------------- */
    </script>
</body>
</html>
