<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AmmoueAI | Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-input { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); }
        #preview-frame, #code-view { height: 100%; width: 100%; border: none; }
        #code-view { font-family: 'Fira Code', monospace; font-size: 13px; outline: none; resize: none; }
        .shimmer { animation: shimmer 2s infinite linear; background: linear-gradient(to right, #eff6ff 4%, #dbeafe 25%, #eff6ff 36%); background-size: 1000px 100%; }
        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        .replit-input:focus-within { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
    </style>
</head>
<body class="bg-[#0f1115] text-gray-300 h-screen flex flex-col overflow-hidden">

    <nav class="border-b border-gray-800 px-4 py-2 flex justify-between items-center bg-[#161b22]">
        <div class="flex items-center gap-4">
            <span class="text-white font-bold tracking-tighter text-lg italic">AmmoueAI</span>
            <div id="view-toggle" class="bg-gray-800 p-1 rounded-md flex gap-1">
                <button id="show-preview" class="px-3 py-1 text-xs font-bold rounded bg-gray-700 text-white transition">Preview</button>
                <button id="show-code" class="px-3 py-1 text-xs font-bold rounded text-gray-400 hover:text-white transition">Code</button>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <span id="user-plan" class="text-[10px] bg-blue-500/10 text-blue-400 border border-blue-500/20 px-2 py-0.5 rounded">FREE</span>
            <div id="user-info" class="hidden flex items-center gap-2">
                <img id="user-avatar" class="w-6 h-6 rounded-full border border-gray-600">
                <button id="logout-btn" class="text-xs hover:text-white">Sign Out</button>
            </div>
            <button id="login-btn" class="text-xs bg-white text-black px-3 py-1.5 rounded-md font-bold">Login</button>
        </div>
    </nav>

    <main class="flex-1 flex overflow-hidden">
        <aside class="w-[350px] border-r border-gray-800 bg-[#0f1115] p-4 flex flex-col justify-between">
            <div class="space-y-4">
                <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-widest">Builder</h2>
                
                <div class="replit-input bg-[#161b22] border border-gray-700 rounded-xl p-3 transition-all">
                    <textarea id="user-prompt" 
                        class="w-full bg-transparent border-none outline-none text-white text-sm resize-none" 
                        placeholder="What should we build today?" rows="4"></textarea>
                    <div class="flex justify-between items-center mt-2">
                        <span id="preview-status" class="text-[10px] text-gray-500 italic">Ready</span>
                        <div class="flex gap-2">
                            <button id="generate-btn" class="bg-blue-600 hover:bg-blue-500 text-white w-8 h-8 rounded-lg flex items-center justify-center transition shadow-lg">
                                <span id="gen-icon">✨</span>
                            </button>
                        </div>
                    </div>
                </div>

                <button id="refine-btn" class="hidden w-full border border-gray-700 text-xs py-2 rounded-lg hover:bg-gray-800 transition">
                    Apply Updates
                </button>
            </div>

            <div id="deploy-section" class="hidden border-t border-gray-800 pt-4 space-y-3">
                <input id="site-slug" type="text" placeholder="project-slug" class="w-full bg-[#161b22] border border-gray-700 rounded-lg p-2 text-xs outline-none focus:border-blue-500">
                <button id="deploy-btn" class="w-full bg-green-600/10 text-green-400 border border-green-600/20 py-2 rounded-lg text-xs font-bold hover:bg-green-600 hover:text-white transition">
                    Deploy to Vercel
                </button>
                <div id="live-url-box" class="hidden text-center">
                    <a id="live-url" href="#" target="_blank" class="text-[10px] text-blue-400 underline">Visit Site</a>
                </div>
            </div>
        </aside>

        <section class="flex-1 bg-[#1c1f26] relative">
            <div id="preview-container" class="w-full h-full">
                <iframe id="preview-frame" class="bg-white"></iframe>
            </div>
            <div id="code-container" class="w-full h-full hidden">
                <textarea id="code-view" class="bg-[#0f1115] text-blue-300 p-6" readonly></textarea>
            </div>
            
            <button id="stop-btn" class="hidden absolute bottom-6 left-1/2 -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded-full text-xs font-bold shadow-2xl hover:bg-red-600 transition">
                <i class="fa-solid fa-stop mr-2"></i> Stop Generation
            </button>
        </section>
    </main>

    <script type="module">
        import { auth, getUserPlan, autoSaveProject } from "./fire_prompt.js";
        import { GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

        let currentHtml = "";
        let currentProjectId = null;
        let userPlan = "free";
        let abortController = null;

        // UI Selectors
        const genBtn = document.getElementById('generate-btn');
        const stopBtn = document.getElementById('stop-btn');
        const promptInput = document.getElementById('user-prompt');
        const previewStatus = document.getElementById('preview-status');
        const codeView = document.getElementById('code-view');
        const previewFrame = document.getElementById('preview-frame');

        /* ---------------- VIEW TOGGLE ---------------- */
        const btnShowPreview = document.getElementById('show-preview');
        const btnShowCode = document.getElementById('show-code');
        const previewCont = document.getElementById('preview-container');
        const codeCont = document.getElementById('code-container');

        btnShowPreview.onclick = () => {
            previewCont.classList.remove('hidden');
            codeCont.classList.add('hidden');
            btnShowPreview.classList.add('bg-gray-700', 'text-white');
            btnShowCode.classList.remove('bg-gray-700', 'text-white');
        };

        btnShowCode.onclick = () => {
            codeCont.classList.remove('hidden');
            previewCont.classList.add('hidden');
            btnShowCode.classList.add('bg-gray-700', 'text-white');
            btnShowPreview.classList.remove('bg-gray-700', 'text-white');
            codeView.value = currentHtml;
        };

        /* ---------------- AUTH ---------------- */
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('login-btn').classList.add('hidden');
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('user-avatar').src = user.photoURL;
                userPlan = await getUserPlan(user.uid);
                document.getElementById('user-plan').innerText = userPlan.toUpperCase();
            } else {
                document.getElementById('login-btn').classList.remove('hidden');
                document.getElementById('user-info').classList.add('hidden');
            }
        });

        document.getElementById('login-btn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        document.getElementById('logout-btn').onclick = () => signOut(auth);

        /* ---------------- GENERATE ---------------- */
        genBtn.onclick = async () => {
            if (!auth.currentUser) return alert("Login to generate");
            if (!promptInput.value) return;

            // Setup UI & Abort Logic
            abortController = new AbortController();
            genBtn.classList.add('opacity-50', 'pointer-events-none');
            document.getElementById('gen-icon').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            stopBtn.classList.remove('hidden');
            previewStatus.innerText = "Writing code...";
            currentHtml = "";

            try {
                const idToken = await auth.currentUser.getIdToken();
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}` },
                    body: JSON.stringify({ prompt: promptInput.value }),
                    signal: abortController.signal
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (!line.startsWith('data: ')) continue;
                        const raw = line.slice(6).trim();
                        if (raw === '[DONE]') break; // <--- FIX FOR YOUR ERROR

                        try {
                            const data = JSON.parse(raw);
                            if (data.text) {
                                currentHtml += data.text;
                                updatePreview(currentHtml);
                            }
                        } catch (e) { console.error("Parse error", e); }
                    }
                }

                currentProjectId = await autoSaveProject(currentHtml, promptInput.value, currentProjectId, auth.currentUser.uid);
                previewStatus.innerText = "Done";
                document.getElementById('deploy-section').classList.remove('hidden');

            } catch (err) {
                if (err.name === 'AbortError') previewStatus.innerText = "Stopped";
                else previewStatus.innerText = "Error!";
            } finally {
                genBtn.classList.remove('opacity-50', 'pointer-events-none');
                document.getElementById('gen-icon').innerText = '✨';
                stopBtn.classList.add('hidden');
            }
        };

        stopBtn.onclick = () => abortController?.abort();

        function updatePreview(html) {
            const blob = new Blob([html], { type: 'text/html' });
            previewFrame.src = URL.createObjectURL(blob);
            if (!codeCont.classList.contains('hidden')) {
                codeView.value = html;
            }
        }
    </script>
</body>
</html>
