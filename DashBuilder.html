<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AmmoueAI | Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background: #0f1115; color: #d1d5db; }
        #preview-frame { transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); background: white; border: none; }
        .mobile-view { width: 375px !important; height: 667px !important; border: 12px solid #374151 !important; border-radius: 32px; box-shadow: 0 0 0 4px #1f2937; }
        
        #code-view { height: 100%; width: 100%; border: none; font-family: 'Fira Code', monospace; font-size: 13px; outline: none; resize: none; color: #a5d6ff; background: #0f1115; padding: 2rem; }
        
        .log-entry { font-size: 11px; color: #9ca3af; margin-bottom: 4px; font-family: 'Fira Code', monospace; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .img-bubble { position: relative; width: 56px; height: 56px; border-radius: 8px; border: 1px solid #374151; overflow: hidden; background: #1c1f26; }
        .img-bubble img { width: 100%; height: 100%; object-fit: cover; }
        .remove-img { position: absolute; top: 2px; right: 2px; background: #ef4444; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; color: white; border: 1px solid #0f1115; }
        
        .history-item { cursor: pointer; transition: all 0.2s; border-left: 2px solid transparent; }
        .history-item:hover { background: #161b22; border-left-color: #3b82f6; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <nav class="border-b border-gray-800 px-4 py-2 flex justify-between items-center bg-[#161b22] z-50">
        <div class="flex items-center gap-4">
            <a href="/dashboard" class="text-gray-400 hover:text-white transition mr-2" title="Back to Dashboard">
                <i class="fa-solid fa-house-chimney text-lg"></i>
            </a>
            <span class="text-white font-black italic tracking-tighter text-xl">AmmoueAI</span>
            
            <div class="flex bg-gray-900 rounded-lg p-1 gap-1 ml-4">
                <button id="toggle-preview" class="px-3 py-1 text-[10px] font-bold rounded bg-blue-600 text-white transition">PREVIEW</button>
                <button id="toggle-code" class="px-3 py-1 text-[10px] font-bold rounded text-gray-400 hover:text-white transition">CODE</button>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <div class="flex items-center gap-1 bg-gray-900 rounded-lg p-1">
                <button id="set-desktop" class="p-1.5 text-blue-500 hover:bg-gray-800 rounded transition"><i class="fa-solid fa-desktop text-xs"></i></button>
                <button id="set-mobile" class="p-1.5 text-gray-500 hover:bg-gray-800 rounded transition"><i class="fa-solid fa-mobile-screen text-xs"></i></button>
                <button id="open-new-tab" class="p-1.5 text-gray-500 hover:bg-gray-800 rounded transition ml-1" title="Open in New Tab"><i class="fa-solid fa-external-link text-xs"></i></button>
            </div>

            <div id="publish-controls" class="flex items-center gap-2 bg-gray-900 p-1 rounded-lg border border-gray-700">
                <input id="slug-input" type="text" placeholder="Project name..." class="bg-transparent border-none outline-none text-xs text-white px-2 w-32 placeholder:text-gray-600">
                <button id="publish-btn" class="bg-green-600 hover:bg-green-500 text-white text-[10px] font-bold px-3 py-1.5 rounded-md transition uppercase tracking-wider">Publish</button>
            </div>
            
            <div id="user-ui" class="hidden flex items-center gap-3 border-l border-gray-800 pl-4">
                <img id="user-avatar" class="w-7 h-7 rounded-full ring-2 ring-gray-700">
                <button id="logout-btn" class="text-[10px] text-gray-400 hover:text-white uppercase font-bold">Sign Out</button>
            </div>
            <button id="login-btn" class="bg-white text-black text-xs font-bold px-4 py-2 rounded-lg">LOGIN</button>
        </div>
    </nav>

    <main class="flex-1 flex overflow-hidden">
        <aside class="w-[380px] border-r border-gray-800 p-4 flex flex-col gap-4 bg-[#0f1115]">
            <div class="flex-1 overflow-y-auto space-y-6 pr-1">
                <div>
                    <h2 class="text-[10px] font-bold text-gray-500 uppercase tracking-[0.2em] mb-3">Creative Prompt</h2>
                    <div class="bg-[#161b22] border border-gray-800 rounded-2xl p-4 focus-within:border-blue-500/50 transition-all duration-300 shadow-2xl">
                        <div id="img-tray" class="flex flex-wrap gap-2 mb-3 empty:hidden"></div>
                        <textarea id="user-prompt" class="w-full bg-transparent border-none outline-none text-sm text-white resize-none placeholder:text-gray-600" rows="5" placeholder="Build a landing page..."></textarea>
                        <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-700">
                            <label class="cursor-pointer text-gray-500 hover:text-blue-400 transition-colors p-2">
                                <i class="fa-solid fa-paperclip text-lg"></i>
                                <input type="file" id="img-input" class="hidden" accept="image/*" multiple>
                            </label>
                            <button id="gen-btn" class="bg-blue-600 hover:bg-blue-500 text-white w-10 h-10 rounded-xl flex items-center justify-center transition-all active:scale-95 shadow-lg">
                                <span id="gen-icon"><i class="fa-solid fa-wand-magic-sparkles"></i></span>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="thinking-box" class="hidden bg-[#0a0c10] border border-gray-800 rounded-xl p-4 max-h-[200px] overflow-y-auto">
                    <div id="logs" class="space-y-1"></div>
                </div>

                <div>
                    <h2 class="text-[10px] font-bold text-gray-500 uppercase tracking-[0.2em] mb-3">Recent Projects</h2>
                    <div id="history-list" class="space-y-1"></div>
                </div>
            </div>

            <div id="url-display" class="hidden bg-green-500/10 border border-green-500/20 p-3 rounded-xl text-center">
                <p class="text-[9px] text-green-500 font-bold uppercase mb-1">Live Deployment</p>
                <a id="final-link" href="#" target="_blank" class="text-xs text-blue-400 font-mono underline break-all"></a>
            </div>
        </aside>

        <section class="flex-1 flex items-center justify-center p-6 bg-[#1c1f26] relative">
            <div id="preview-wrapper" class="w-full h-full flex items-center justify-center relative">
                <iframe id="preview-frame" class="shadow-2xl w-full h-full"></iframe>
                <textarea id="code-view" class="hidden" readonly></textarea>
                
                <button id="copy-code-btn" class="hidden absolute top-4 right-4 bg-gray-800/80 hover:bg-blue-600 text-white px-3 py-1.5 rounded-md text-[10px] font-bold transition-all border border-gray-700 backdrop-blur-sm">
                    <i class="fa-solid fa-copy mr-2"></i> COPY CODE
                </button>
            </div>
            
            <button id="stop-btn" class="hidden absolute bottom-10 bg-red-500 hover:bg-red-400 text-white px-6 py-2 rounded-full font-bold text-sm shadow-xl z-50">
                <i class="fa-solid fa-circle-stop mr-2"></i> STOP GENERATION
            </button>
        </section>
    </main>

    <script type="module">
        import { auth, getUserPlan, autoSaveProject, updateProjectDeploymentUrl } from "./fire_prompt.js";
        import { GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

        let currentHtml = "";
        let currentProjectId = null;
        let attachedImages = [];
        let abortCtrl = null;

        const genBtn = document.getElementById('gen-btn');
        const imgInput = document.getElementById('img-input');
        const imgTray = document.getElementById('img-tray');
        const logs = document.getElementById('logs');
        const frame = document.getElementById('preview-frame');
        const codeView = document.getElementById('code-view');
        const copyBtn = document.getElementById('copy-code-btn');

        /* ---------------- VIEW TOGGLES ---------------- */
        const btnPreview = document.getElementById('toggle-preview');
        const btnCode = document.getElementById('toggle-code');

        btnPreview.onclick = () => {
            frame.classList.remove('hidden');
            codeView.classList.add('hidden');
            copyBtn.classList.add('hidden');
            btnPreview.className = "px-3 py-1 text-[10px] font-bold rounded bg-blue-600 text-white transition";
            btnCode.className = "px-3 py-1 text-[10px] font-bold rounded text-gray-400 hover:text-white transition";
        };

        btnCode.onclick = () => {
            codeView.classList.remove('hidden');
            frame.classList.add('hidden');
            copyBtn.classList.remove('hidden');
            btnCode.className = "px-3 py-1 text-[10px] font-bold rounded bg-blue-600 text-white transition";
            btnPreview.className = "px-3 py-1 text-[10px] font-bold rounded text-gray-400 hover:text-white transition";
            codeView.value = currentHtml;
        };

        copyBtn.onclick = () => {
            navigator.clipboard.writeText(currentHtml);
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = '<i class="fa-solid fa-check mr-2"></i> COPIED!';
            setTimeout(() => copyBtn.innerHTML = originalText, 2000);
        };

        /* ---------------- IMAGE PREVIEW ---------------- */
        imgInput.onchange = async (e) => {
            const files = Array.from(e.target.files);
            for (const file of files) {
                if (attachedImages.length >= 4) break;
                attachedImages.push(await toBase64(file));
            }
            renderImages();
            imgInput.value = "";
        };

        function toBase64(file) {
            return new Promise(r => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => r(reader.result);
            });
        }

        function renderImages() {
            imgTray.innerHTML = attachedImages.map((src, i) => `
                <div class="img-bubble">
                    <img src="${src}">
                    <div class="remove-img" onclick="removeImg(${i})"><i class="fa-solid fa-xmark"></i></div>
                </div>
            `).join('');
        }
        window.removeImg = (i) => { attachedImages.splice(i, 1); renderImages(); };

        /* ---------------- GENERATE ---------------- */
        genBtn.onclick = async () => {
            if (!auth.currentUser) return signInWithPopup(auth, new GoogleAuthProvider());
            
            abortCtrl = new AbortController();
            document.getElementById('thinking-box').classList.remove('hidden');
            logs.innerHTML = '<div class="log-entry">> Initiating neural synthesis...</div>';
            currentHtml = "";
            genBtn.disabled = true;
            document.getElementById('gen-icon').innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';

            try {
                const token = await auth.currentUser.getIdToken();
                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ prompt: document.getElementById('user-prompt').value, images: attachedImages }),
                    signal: abortCtrl.signal
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (!line.startsWith('data: ')) continue;
                        const dataStr = line.slice(6).trim();
                        if (dataStr === '[DONE]') break;
                        try {
                            const json = JSON.parse(dataStr);
                            if (json.text) {
                                currentHtml += json.text;
                                updateFrame(currentHtml);
                            }
                        } catch (e) {}
                    }
                }
                
                currentProjectId = await autoSaveProject(currentHtml, document.getElementById('user-prompt').value, currentProjectId, auth.currentUser.uid);
                addToHistory(document.getElementById('user-prompt').value);
                logs.innerHTML += '<div class="log-entry text-blue-400">> Assets optimized and saved.</div>';
            } catch (err) {
                logs.innerHTML += '<div class="log-entry text-red-400">> Process terminated.</div>';
            } finally {
                genBtn.disabled = false;
                document.getElementById('gen-icon').innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i>';
            }
        };

        function addToHistory(prompt) {
            const list = document.getElementById('history-list');
            const item = document.createElement('div');
            item.className = 'history-item p-3 text-xs bg-[#161b22]/50 rounded-lg text-gray-400 truncate';
            item.innerText = prompt;
            list.prepend(item);
        }

        /* ---------------- PUBLISH ---------------- */
        document.getElementById('publish-btn').onclick = async () => {
            const slug = document.getElementById('slug-input').value;
            if (!slug) return alert("Enter a project name first.");
            const btn = document.getElementById('publish-btn');
            btn.innerText = "DEPLOYING...";
            btn.disabled = true;
            
            try {
                const res = await fetch('/api/deploy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        htmlContent: currentHtml,
                        userId: auth.currentUser.uid,
                        plan: await getUserPlan(auth.currentUser.uid),
                        projectId: currentProjectId,
                        slug: slug
                    })
                });
                const data = await res.json();
                if (data.deploymentUrl) {
                    await updateProjectDeploymentUrl(currentProjectId, data.deploymentUrl, auth.currentUser.uid);
                    document.getElementById('url-display').classList.remove('hidden');
                    document.getElementById('final-link').href = data.deploymentUrl;
                    document.getElementById('final-link').innerText = data.deploymentUrl;
                    btn.innerText = "LIVE";
                }
            } catch (e) {
                btn.innerText = "PUBLISH";
                btn.disabled = false;
            }
        };

        /* ---------------- DEVICE HELPERS ---------------- */
        document.getElementById('set-desktop').onclick = () => {
            frame.className = "shadow-2xl w-full h-full";
            document.getElementById('set-desktop').classList.add('text-blue-500');
            document.getElementById('set-mobile').classList.replace('text-blue-500', 'text-gray-500');
        };
        document.getElementById('set-mobile').onclick = () => {
            frame.className = "mobile-view";
            document.getElementById('set-mobile').classList.add('text-blue-500');
            document.getElementById('set-desktop').classList.replace('text-blue-500', 'text-gray-500');
        };
        document.getElementById('open-new-tab').onclick = () => {
            const w = window.open('about:blank');
            w.document.write(currentHtml);
            w.document.close();
        };

        function updateFrame(h) {
            const blob = new Blob([h], { type: 'text/html' });
            frame.src = URL.createObjectURL(blob);
            codeView.value = h;
        }

        onAuthStateChanged(auth, u => {
            if (u) {
                document.getElementById('user-ui').classList.remove('hidden');
                document.getElementById('login-btn').classList.add('hidden');
                document.getElementById('user-avatar').src = u.photoURL;
            } else {
                document.getElementById('user-ui').classList.add('hidden');
                document.getElementById('login-btn').classList.remove('hidden');
            }
        });
        document.getElementById('logout-btn').onclick = () => signOut(auth);
    </script>
</body>
</html>
