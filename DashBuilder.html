<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AmmoueAI | Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background: #0f1115; color: #d1d5db; }
        #preview-frame { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); background: white; border: none; }
        .mobile-view { width: 375px !important; height: 667px !important; border: 12px solid #374151 !important; border-radius: 32px; }
        
        /* Thinking Console Styling */
        .log-entry { font-size: 11px; color: #9ca3af; margin-bottom: 4px; font-family: 'Fira Code', monospace; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Image Bubble Styling */
        .img-bubble { position: relative; width: 56px; height: 56px; border-radius: 8px; border: 1px solid #374151; overflow: hidden; }
        .img-bubble img { width: 100%; height: 100%; object-cover: cover; }
        .remove-img { position: absolute; top: 2px; right: 2px; background: rgba(239, 68, 68, 0.9); width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; color: white; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <nav class="border-b border-gray-800 px-4 py-2 flex justify-between items-center bg-[#161b22] z-50">
        <div class="flex items-center gap-6">
            <span class="text-white font-black italic tracking-tighter text-xl">AmmoueAI</span>
            <div class="flex bg-gray-900 rounded-lg p-1 gap-1">
                <button id="set-desktop" class="p-2 text-blue-500 hover:bg-gray-800 rounded transition"><i class="fa-solid fa-desktop"></i></button>
                <button id="set-mobile" class="p-2 text-gray-500 hover:bg-gray-800 rounded transition"><i class="fa-solid fa-mobile-screen"></i></button>
                <button id="open-new-tab" class="p-2 text-gray-500 hover:bg-gray-800 rounded transition"><i class="fa-solid fa-arrow-up-right-from-square"></i></button>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <button id="publish-btn" class="hidden bg-green-600 hover:bg-green-500 text-white text-xs font-bold px-4 py-2 rounded-lg transition">Publish Site</button>
            <div id="user-ui" class="hidden flex items-center gap-3">
                <img id="user-avatar" class="w-7 h-7 rounded-full ring-2 ring-gray-700">
                <button id="logout-btn" class="text-xs text-gray-400 hover:text-white">Sign Out</button>
            </div>
            <button id="login-btn" class="bg-white text-black text-xs font-bold px-4 py-2 rounded-lg">Login</button>
        </div>
    </nav>

    <main class="flex-1 flex overflow-hidden">
        <aside class="w-[400px] border-r border-gray-800 p-4 flex flex-col gap-4 bg-[#0f1115]">
            <div class="flex-1 overflow-y-auto space-y-4 pr-1">
                <div class="bg-[#161b22] border border-gray-800 rounded-2xl p-4 focus-within:border-blue-500 transition shadow-2xl">
                    <div id="img-tray" class="flex gap-2 mb-3 empty:hidden"></div>
                    
                    <textarea id="user-prompt" class="w-full bg-transparent border-none outline-none text-sm text-white resize-none" rows="5" placeholder="Ask AI to build something..."></textarea>
                    
                    <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-800">
                        <label class="cursor-pointer text-gray-500 hover:text-blue-400 transition">
                            <i class="fa-solid fa-camera-retro text-lg"></i>
                            <input type="file" id="img-input" class="hidden" accept="image/*" multiple>
                        </label>
                        <button id="gen-btn" class="bg-blue-600 hover:bg-blue-500 text-white w-10 h-10 rounded-xl flex items-center justify-center transition active:scale-95 shadow-lg">
                            <span id="gen-icon">âœ¨</span>
                        </button>
                    </div>
                </div>

                <div id="thinking-box" class="hidden bg-[#0a0c10] border border-gray-800 rounded-xl p-4 max-h-[250px] overflow-y-auto">
                    <div id="logs" class="space-y-1"></div>
                </div>
            </div>

            <div id="deploy-panel" class="hidden border-t border-gray-800 pt-4 space-y-3">
                <input id="slug-input" type="text" placeholder="project-name" class="w-full bg-[#161b22] border border-gray-800 rounded-lg p-3 text-xs text-white outline-none focus:ring-1 focus:ring-blue-500">
                <div id="url-display" class="hidden bg-blue-500/10 border border-blue-500/30 p-3 rounded-lg text-center">
                    <a id="final-link" href="#" target="_blank" class="text-xs text-blue-400 font-mono underline"></a>
                </div>
            </div>
        </aside>

        <section class="flex-1 flex items-center justify-center p-8 bg-[#1c1f26] relative">
            <div id="viewport" class="w-full h-full flex items-center justify-center">
                <iframe id="preview-frame" class="shadow-2xl w-full h-full"></iframe>
            </div>
            
            <button id="stop-btn" class="hidden absolute bottom-10 bg-red-500 hover:bg-red-400 text-white px-6 py-2 rounded-full font-bold text-sm shadow-xl transition-all z-50">
                <i class="fa-solid fa-hand mr-2"></i> Stop Generation
            </button>
        </section>
    </main>

    <script type="module">
        import { auth, getUserPlan, autoSaveProject, updateProjectDeploymentUrl } from "./fire_prompt.js";
        import { GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

        let currentHtml = "";
        let currentProjectId = null;
        let attachedImages = [];
        let abortCtrl = null;

        const genBtn = document.getElementById('gen-btn');
        const imgInput = document.getElementById('img-input');
        const imgTray = document.getElementById('img-tray');
        const logs = document.getElementById('logs');
        const frame = document.getElementById('preview-frame');

        /* ---------------- IMAGE PREVIEW LOGIC ---------------- */
        imgInput.onchange = async (e) => {
            const files = Array.from(e.target.files);
            for (const file of files) {
                if (attachedImages.length >= 4) break;
                const base64 = await toBase64(file);
                attachedImages.push(base64);
            }
            renderImages();
            imgInput.value = "";
        };

        function toBase64(file) {
            return new Promise(r => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => r(reader.result);
            });
        }

        function renderImages() {
            imgTray.innerHTML = attachedImages.map((src, i) => `
                <div class="img-bubble">
                    <img src="${src}">
                    <div class="remove-img" onclick="removeImg(${i})"><i class="fa-solid fa-x"></i></div>
                </div>
            `).join('');
        }

        window.removeImg = (i) => {
            attachedImages.splice(i, 1);
            renderImages();
        };

        /* ---------------- GENERATE LOGIC ---------------- */
        genBtn.onclick = async () => {
            if (!auth.currentUser) return signInWithPopup(auth, new GoogleAuthProvider());
            
            abortCtrl = new AbortController();
            document.getElementById('thinking-box').classList.remove('hidden');
            logs.innerHTML = '<div class="log-entry">> Initializing AI engine...</div>';
            currentHtml = "";
            genBtn.disabled = true;

            try {
                const token = await auth.currentUser.getIdToken();
                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ 
                        prompt: document.getElementById('user-prompt').value,
                        images: attachedImages 
                    }),
                    signal: abortCtrl.signal
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (!line.startsWith('data: ')) continue;
                        const dataStr = line.slice(6).trim();
                        if (dataStr === '[DONE]') break;
                        try {
                            const json = JSON.parse(dataStr);
                            if (json.text) {
                                currentHtml += json.text;
                                updateFrame(currentHtml);
                            }
                        } catch (e) {}
                    }
                }
                
                currentProjectId = await autoSaveProject(currentHtml, document.getElementById('user-prompt').value, currentProjectId, auth.currentUser.uid);
                document.getElementById('deploy-panel').classList.remove('hidden');
                document.getElementById('publish-btn').classList.remove('hidden');
                logs.innerHTML += '<div class="log-entry text-blue-400">> Generation complete.</div>';
            } catch (err) {
                logs.innerHTML += '<div class="log-entry text-red-400">> Error: Connection reset.</div>';
            } finally {
                genBtn.disabled = false;
            }
        };

        /* ---------------- PUBLISH & HELPERS ---------------- */
        document.getElementById('publish-btn').onclick = async () => {
            const slug = document.getElementById('slug-input').value;
            if (!slug) return alert("Enter a project name first.");
            
            document.getElementById('publish-btn').innerText = "Deploying...";
            
            try {
                const res = await fetch('/api/deploy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        htmlContent: currentHtml,
                        userId: auth.currentUser.uid,
                        plan: await getUserPlan(auth.currentUser.uid),
                        projectId: currentProjectId,
                        slug: slug
                    })
                });
                
                const data = await res.json();
                if (data.deploymentUrl) {
                    await updateProjectDeploymentUrl(currentProjectId, data.deploymentUrl, auth.currentUser.uid);
                    document.getElementById('url-display').classList.remove('hidden');
                    document.getElementById('final-link').href = data.deploymentUrl;
                    document.getElementById('final-link').innerText = data.deploymentUrl;
                    document.getElementById('publish-btn').innerText = "Live!";
                }
            } catch (e) {
                alert("Publish failed.");
                document.getElementById('publish-btn').innerText = "Publish Site";
            }
        };

        // Device Toggles
        document.getElementById('set-desktop').onclick = () => frame.className = "shadow-2xl w-full h-full";
        document.getElementById('set-mobile').onclick = () => frame.className = "mobile-view";
        document.getElementById('open-new-tab').onclick = () => {
            const w = window.open('about:blank');
            w.document.write(currentHtml);
            w.document.close();
        };

        function updateFrame(h) {
            const blob = new Blob([h], { type: 'text/html' });
            frame.src = URL.createObjectURL(blob);
        }

        onAuthStateChanged(auth, u => {
            if (u) {
                document.getElementById('user-ui').classList.remove('hidden');
                document.getElementById('login-btn').classList.add('hidden');
                document.getElementById('user-avatar').src = u.photoURL;
            } else {
                document.getElementById('user-ui').classList.add('hidden');
                document.getElementById('login-btn').classList.remove('hidden');
            }
        });
        document.getElementById('logout-btn').onclick = () => signOut(auth);
    </script>
</body>
</html>
