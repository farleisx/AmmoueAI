<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Ammoue | AI Site Generator</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <script src="https://unpkg.com/lucide@latest"></script>
Â  Â  <style>
Â  Â  Â  Â  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  Â  Â  background-color: #f8fafc;
Â  Â  Â  Â  }
Â  Â  Â  Â  .text-ammoue { color: #0d9488; }
Â  Â  Â  Â  .bg-ammoue { background-color: #0d9488; }
Â  Â  Â  Â  /* Style to ensure the loading screen covers the whole view */
Â  Â  Â  Â  #loading-state {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  background-color: #fff;
Â  Â  Â  Â  Â  Â  z-index: 100;
Â  Â  Â  Â  Â  Â  /* Added transition for smoother removal */
Â  Â  Â  Â  Â  Â  transition: opacity 0.3s ease-in-out;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Custom styles for message box */
Â  Â  Â  Â  #message-box {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 20px;
Â  Â  Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  Â  Â  transition: opacity 0.3s ease-in-out;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body class="antialiased min-h-screen">
Â  Â  
Â  Â  Â  Â  <audio id="success-sound" src="success-sound.mp3" preload="auto"></audio>

Â  Â  <div id="message-box" class="p-4 rounded-xl shadow-2xl text-white font-semibold"></div>

Â  Â  <div id="loading-state">
Â  Â  Â  Â  <div class="flex flex-col items-center">
Â  Â  Â  Â  Â  Â  <svg class="animate-spin h-8 w-8 text-ammoue mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
Â  Â  Â  Â  Â  Â  Â  Â  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
Â  Â  Â  Â  Â  Â  Â  Â  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  <p class="text-gray-600 font-medium">Verifying session...</p>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="main-content" class="max-w-4xl mx-auto p-6 lg:p-10 hidden">
Â  Â  Â  Â  <h1 class="text-4xl font-extrabold text-gray-900 mb-4">Generate Your AI Website</h1>
Â  Â  Â  Â  <p class="text-xl text-gray-500 mb-8">Tell Ammoue exactly what website you want to generate (e.g., 'A modern portfolio site for a UX designer with a dark theme').</p>

Â  Â  Â  Â  <textarea id="ai-prompt" rows="6" class="w-full p-4 border-2 border-ammoue/30 rounded-2xl focus:ring-ammoue focus:border-ammoue transition duration-150 shadow-md" placeholder="e.g., 'A vibrant landing page for a dog grooming salon called Paws & Claws, focusing on luxury services and online booking.'"></textarea>

Â  Â  Â  Â  <div class="mt-6 flex justify-end space-x-4">
Â  Â  Â  Â  Â  Â  <a href="dashboard.html" class="px-6 py-3 text-base font-semibold rounded-xl text-gray-600 border border-gray-300 hover:bg-gray-100 transition duration-300 flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="layout-dashboard" class="w-4 h-4 mr-1"></i> Dashboard
Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  <button id="logout-btn" class="px-6 py-3 text-base font-semibold rounded-xl text-gray-600 border border-gray-300 hover:bg-gray-100 transition duration-300">
Â  Â  Â  Â  Â  Â  Â  Â  Log Out
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <button id="generate-btn" class="px-8 py-3 text-lg font-bold rounded-xl text-white bg-ammoue hover:bg-teal-700 transition duration-300 shadow-lg shadow-teal-500/30 transform hover:scale-[1.01]">
Â  Â  Â  Â  Â  Â  Â  Â  Generate HTML Code
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="mt-10 p-6 bg-white border border-gray-200 rounded-2xl shadow-xl">
Â  Â  Â  Â  Â  Â  <h2 class="text-3xl font-extrabold text-ammoue mb-3 flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="sparkles" class="w-6 h-6 mr-2"></i> AI Refinement Agent
Â  Â  Â  Â  Â  Â  </h2>
Â  Â  Â  Â  Â  Â  <p class="text-lg text-gray-500 mb-6">
Â  Â  Â  Â  Â  Â  Â  Â  Refine the **current generated code**. Tell the agent what to change, add, or remove.
Â  Â  Â  Â  Â  Â  </p>

Â  Â  Â  Â  Â  Â  <textarea id="refine-prompt" rows="3" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="e.g., 'Make the primary button color a bright orange' or 'Add a 3-column feature section under the hero.'"></textarea>

Â  Â  Â  Â  Â  Â  <div class="mt-4 flex justify-end">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="refine-btn" disabled class="px-8 py-3 text-lg font-bold rounded-xl text-white bg-blue-600 hover:bg-blue-700 transition duration-300 shadow-lg shadow-blue-500/30 disabled:opacity-50 disabled:cursor-not-allowed">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Refine Code
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="generation-output" class="mt-12 p-6 bg-white border border-gray-100 rounded-2xl shadow-lg hidden">
Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-2xl font-bold text-gray-800 flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="code" class="w-5 h-5 mr-2 text-ammoue"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Generated HTML Code
Â  Â  Â  Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex space-x-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="copy-btn" class="text-sm font-medium text-ammoue hover:text-teal-600 flex items-center transition duration-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="copy" class="w-4 h-4 mr-1"></i> Copy Code
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="download-btn" disabled class="text-sm font-medium text-blue-600 hover:text-blue-700 disabled:text-gray-400 flex items-center transition duration-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="download" class="w-4 h-4 mr-1"></i> Download HTML
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <pre class="bg-gray-100 p-4 rounded-xl overflow-x-auto border border-gray-300 text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  <code id="output-code" class="whitespace-pre"></code>
Â  Â  Â  Â  Â  Â  </pre>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <button id="preview-btn" class="mt-4 px-6 py-2 text-base font-semibold rounded-xl text-white bg-blue-600 hover:bg-blue-700 transition duration-300">
Â  Â  Â  Â  Â  Â  Â  Â  Preview Site (Will open in a new tab)
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script type="module">
Â  Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
Â  Â  Â  Â  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
Â  Â  Â  Â  // Imports for Firestore Auto-Saving
Â  Â  Â  Â  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- FIREBASE CONFIGURATION ---
Â  Â  Â  Â  const firebaseConfig = {
Â  Â  Â  Â  Â  Â  apiKey: "AIzaSyAmnZ69YDcEFcmuXIhmGxDUSPULxpI-Bmg",
Â  Â  Â  Â  Â  Â  authDomain: "ammoueai.firebaseapp.com",
Â  Â  Â  Â  Â  Â  projectId: "ammoueai",
Â  Â  Â  Â  Â  Â  storageBucket: "ammoueai.firebasestorage.app",
Â  Â  Â  Â  Â  Â  messagingSenderId: "135818868149",
Â  Â  Â  Â  Â  Â  appId: "1:135818868149:web:db9280baf9540a3339d5fc",
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- Initialize Firebase and Services ---
Â  Â  Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  Â  Â  const auth = getAuth(app);
Â  Â  Â  Â  const db = getFirestore(app); // Firestore initialization
Â  Â  Â  Â  const appId = firebaseConfig.projectId; // App ID for nested path
Â  Â  Â  Â  let currentUserId = null; // Stores the logged-in user's UID

Â  Â  Â  Â  // --- DOM Elements ---
Â  Â  Â  Â  const loadingState = document.getElementById('loading-state');
Â  Â  Â  Â  const mainContent = document.getElementById('main-content');
Â  Â  Â  Â  const logoutBtn = document.getElementById('logout-btn');
Â  Â  Â  Â  const generateBtn = document.getElementById('generate-btn');
Â  Â  Â  Â  const downloadBtn = document.getElementById('download-btn');
Â  Â  Â  Â  const promptInput = document.getElementById('ai-prompt');
Â  Â  Â  Â  const outputDiv = document.getElementById('generation-output');
Â  Â  Â  Â  const outputCode = document.getElementById('output-code');
Â  Â  Â  Â  const copyBtn = document.getElementById('copy-btn');
Â  Â  Â  Â  const previewBtn = document.getElementById('preview-btn');
Â  Â  Â  Â  const messageBox = document.getElementById('message-box');
Â  Â  Â  Â  // NEW: Refinement Agent Elements
Â  Â  Â  Â  const refinePromptInput = document.getElementById('refine-prompt');
Â  Â  Â  Â  const refineBtn = document.getElementById('refine-btn');
        // ğŸŒŸ NEW: AUDIO DOM ELEMENT ğŸŒŸ
        const successSound = document.getElementById('success-sound');

Â  Â  Â  Â  let listenersAttached = false;
Â  Â  Â  Â  let latestHtmlContent = '';Â 
Â  Â  Â  Â  let latestPrompt = '';Â 

Â  Â  Â  Â  // --- Utility Functions ---

        /** Plays the success sound. (NEW FUNCTION) */
        function playSound() {
            if (successSound) {
                // Stop and rewind the sound to allow quick replays
                successSound.pause();
                successSound.currentTime = 0;
                // Use .catch to prevent an unhandled promise rejection if user hasn't interacted yet
                successSound.play().catch(e => console.error("Sound playback failed (user interaction required):", e));
            }
        }

Â  Â  Â  Â  /** Displays a temporary, custom message box. */
Â  Â  Â  Â  function showMessage(message, isError) {
Â  Â  Â  Â  Â  Â  messageBox.textContent = message;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (isError) {
Â  Â  Â  Â  Â  Â  Â  Â  messageBox.classList.remove('bg-green-500', 'bg-ammoue');
Â  Â  Â  Â  Â  Â  Â  Â  messageBox.classList.add('bg-red-500');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  messageBox.classList.remove('bg-red-500');
Â  Â  Â  Â  Â  Â  Â  Â  messageBox.classList.add('bg-ammoue');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  messageBox.classList.remove('opacity-0');
Â  Â  Â  Â  Â  Â  messageBox.classList.add('opacity-100');

Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  messageBox.classList.remove('opacity-100');
Â  Â  Â  Â  Â  Â  Â  Â  messageBox.classList.add('opacity-0');
Â  Â  Â  Â  Â  Â  }, 4000);
Â  Â  Â  Â  }

Â  Â  Â  Â  /** Sets the loading state on the generate button. (MODIFIED) */
Â  Â  Â  Â  function setLoading(isLoading) {
Â  Â  Â  Â  Â  Â  if (isLoading) {
Â  Â  Â  Â  Â  Â  Â  Â  generateBtn.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  refineBtn.disabled = true; // Disable refine while generating
Â  Â  Â  Â  Â  Â  Â  Â  downloadBtn.disabled = true;Â 
Â  Â  Â  Â  Â  Â  Â  Â  generateBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating...';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  generateBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  generateBtn.innerHTML = 'Generate HTML Code';
Â  Â  Â  Â  Â  Â  Â  Â  // Only enable refine if there is content
Â  Â  Â  Â  Â  Â  Â  Â  if (latestHtmlContent) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refineBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /** Sets the loading state on the refine button. (NEW FUNCTION) */
Â  Â  Â  Â  function setRefineLoading(isLoading) {
Â  Â  Â  Â  Â  Â  if (isLoading) {
Â  Â  Â  Â  Â  Â  Â  Â  refineBtn.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  generateBtn.disabled = true; // Disable generation while refining
Â  Â  Â  Â  Â  Â  Â  Â  downloadBtn.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  refineBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Refining...';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  refineBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  generateBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  // Re-enable refine and download if there is content
Â  Â  Â  Â  Â  Â  Â  Â  if (latestHtmlContent) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  downloadBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  refineBtn.innerHTML = 'Refine Code';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  /** Utility function to copy text to clipboard. */
Â  Â  Â  Â  function copyToClipboard(text) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const textarea = document.createElement('textarea');
Â  Â  Â  Â  Â  Â  Â  Â  textarea.value = text;
Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(textarea);
Â  Â  Â  Â  Â  Â  Â  Â  textarea.select();
Â  Â  Â  Â  Â  Â  Â  Â  document.execCommand('copy');
Â  Â  Â  Â  Â  Â  Â  Â  document.body.removeChild(textarea);
Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Code copied to clipboard!", false);
Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Failed to copy text:', err);
Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Failed to copy code.", true);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /** Handles downloading the generated HTML content. */
Â  Â  Â  Â  function handleDownload() {
Â  Â  Â  Â  Â  Â  const htmlCode = outputCode.textContent;
Â  Â  Â  Â  Â  Â  if (!htmlCode) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage("No HTML code available to download.", true);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const blob = new Blob([htmlCode], { type: "text/html" });
Â  Â  Â  Â  Â  Â  const link = document.createElement("a");
Â  Â  Â  Â  Â  Â  link.href = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  link.download = "ammoue_website.html";Â 
Â  Â  Â  Â  Â  Â  document.body.appendChild(link);
Â  Â  Â  Â  Â  Â  link.click();
Â  Â  Â  Â  Â  Â  document.body.removeChild(link);
Â  Â  Â  Â  Â  Â  showMessage("Download started!", false);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /** Opens the generated HTML in a new window for a live preview. */
Â  Â  Â  Â  function handlePreview() {
Â  Â  Â  Â  Â  Â  const htmlContent = previewBtn.dataset.html;
Â  Â  Â  Â  Â  Â  if (!htmlContent) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage("No HTML code available to preview.", true);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const previewWindow = window.open('', '_blank');
Â  Â  Â  Â  Â  Â  if (!previewWindow) {
Â  Â  Â  Â  Â  Â  Â  Â  Â showMessage("Pop-ups must be enabled to view the preview.", true);
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  previewWindow.document.write(htmlContent);
Â  Â  Â  Â  Â  Â  previewWindow.document.close();
Â  Â  Â  Â  }

Â  Â  Â  Â  // *** Auto-Save Logic (runs after successful generation/refinement) ***
Â  Â  Â  Â  async function autoSaveProject(htmlContent, userPrompt) {
Â  Â  Â  Â  Â  Â  if (!currentUserId || !htmlContent) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Auto-save failed: Missing user ID or content.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // â­ CRITICAL FIX: Clean the prompt data before saving it to Firestore â­
Â  Â  Â  Â  Â  Â  const cleanedPrompt = userPrompt.replace(/\\n/g, '\n');

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Secure Nested Path: /artifacts/{appId}/users/{userId}/projects
Â  Â  Â  Â  Â  Â  Â  Â  const projectsRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'projects');

Â  Â  Â  Â  Â  Â  Â  Â  await addDoc(projectsRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  prompt: cleanedPrompt, // USE THE CLEANED PROMPT HERE
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  htmlContent: htmlContent,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createdAt: serverTimestamp(),Â 
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  console.log("Project auto-saved successfully.");

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error during auto-save:", error);
Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Warning: Failed to auto-save project.", true);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- AI Generation Logic ---

Â  Â  Â  Â  /** Handles the initial generation process. */
Â  Â  Â  Â  async function handleGeneration() {
Â  Â  Â  Â  Â  Â  const prompt = promptInput.value.trim();
Â  Â  Â  Â  Â  Â  if (prompt.length < 10) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Please provide a more detailed prompt (at least 10 characters).", true);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  setLoading(true);
Â  Â  Â  Â  Â  Â  outputDiv.classList.add('hidden');
Â  Â  Â  Â  Â  Â  outputCode.textContent = '';Â 
Â  Â  Â  Â  Â  Â  downloadBtn.disabled = true;Â 

Â  Â  Â  Â  Â  Â  latestPrompt = prompt;

Â  Â  Â  Â  Â  Â  const apiEndpoint = '/api/generate.js';Â 
Â  Â  Â  Â  Â  Â  console.log(`Attempting to call AI endpoint: ${apiEndpoint}`);

Â  Â  Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  Â  Â  Â  prompt: prompt,
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const maxRetries = 3;
Â  Â  Â  Â  Â  Â  for (let attempt = 0; attempt < maxRetries; attempt++) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(apiEndpoint, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorBody = await response.json().catch(() => ({}));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorMessage = errorBody.error || response.statusText || "Unknown server error.";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error(`Attempt ${attempt + 1} Server Error: Status ${response.status}`, errorMessage);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`API Proxy Error [Status: ${response.status}]: ${errorMessage}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const generatedHtml = result.htmlCode;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (generatedHtml) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const finalHtml = generatedHtml.trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  outputCode.textContent = finalHtml;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  latestHtmlContent = finalHtml;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previewBtn.dataset.html = finalHtml;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  outputDiv.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  downloadBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Enable the refine button once content exists
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refineBtn.disabled = false;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
                        // ğŸŒŸ PLAY SOUND ON SUCCESS ğŸŒŸ
                        playSound();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage("HTML generated successfully! Project auto-saved.", false);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // CRITICAL STEP: AUTO-SAVE ASYNCHRONOUSLY
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  autoSaveProject(finalHtml, latestPrompt);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break; // Exit loop on success
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error(`Attempt ${attempt + 1} Response Structure Error: 'htmlCode' missing in result.`, result);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("API response missing 'htmlCode' content.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error(`Attempt ${attempt + 1} failed:`, error.message);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (attempt === maxRetries - 1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Generation failed after multiple retries.", true);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const delay = Math.pow(2, attempt) * 1000;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, delay));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  setLoading(false);
Â  Â  Â  Â  }

Â  Â  Â  Â  /** Handles the AI refinement process. (NEW FUNCTION) */
Â  Â  Â  Â  async function handleRefine() {
Â  Â  Â  Â  Â  Â  const refinePrompt = refinePromptInput.value.trim();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!latestHtmlContent) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Please generate initial HTML first.", true);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (refinePrompt.length < 5) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Please enter a detailed refinement instruction (at least 5 characters).", true);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  setRefineLoading(true);

Â  Â  Â  Â  Â  Â  // This is the new API endpoint you need to implement
Â  Â  Â  Â  Â  Â  const apiEndpoint = '/api/refine.js';Â 
Â  Â  Â  Â  Â  Â  console.log(`Attempting to call AI refinement endpoint: ${apiEndpoint}`);

Â  Â  Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  Â  Â  Â  currentHtml: latestHtmlContent, // Pass the existing code
Â  Â  Â  Â  Â  Â  Â  Â  refinePrompt: refinePrompt,Â  Â  Â // Pass the refinement instruction
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const maxRetries = 3;
Â  Â  Â  Â  Â  Â  for (let attempt = 0; attempt < maxRetries; attempt++) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(apiEndpoint, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorBody = await response.json().catch(() => ({}));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorMessage = errorBody.error || response.statusText || "Unknown server error.";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`API Proxy Error [Status: ${response.status}]: ${errorMessage}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const generatedHtml = result.htmlCode;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (generatedHtml) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const finalHtml = generatedHtml.trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  outputCode.textContent = finalHtml;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  latestHtmlContent = finalHtml;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Append refinement to the prompt history for saving
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  latestPrompt = (latestPrompt || promptInput.value.trim()) + `\n\n[Refined]: ${refinePrompt}`;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previewBtn.dataset.html = finalHtml;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  outputDiv.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  downloadBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
                        // ğŸŒŸ PLAY SOUND ON REFINEMENT SUCCESS ğŸŒŸ
                        playSound();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // CRITICAL STEP: AUTO-SAVE ASYNCHRONOUSLY
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  autoSaveProject(finalHtml, latestPrompt);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Code refined and auto-saved!", false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refinePromptInput.value = ''; // Clear the refinement prompt
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break; // Exit loop on success
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("API response missing 'htmlCode' content.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error(`Refine Attempt ${attempt + 1} failed:`, error.message);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (attempt === maxRetries - 1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Refinement failed after multiple retries.", true);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const delay = Math.pow(2, attempt) * 1000;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, delay));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  setRefineLoading(false);
Â  Â  Â  Â  }


Â  Â  Â  Â  // ------------------------------------------------------------------
Â  Â  Â  Â  // â­ CODE FOR TYPING PLACEHOLDER EFFECT STARTS HERE â­
Â  Â  Â  Â  // ------------------------------------------------------------------

Â  Â  Â  Â  const placeholderPrompts = [
Â  Â  Â  Â  Â  Â  "A minimalist portfolio for a futuristic fashion designer.",
Â  Â  Â  Â  Â  Â  "A quirky online cafÃ© with interactive menu animations.",
Â  Â  Â  Â  Â  Â  "A landing page for a mysterious escape room experience.",
Â  Â  Â  Â  Â  Â  "A retro-style blog for sharing bizarre urban legends.",
Â  Â  Â  Â  Â  Â  "A pet adoption site that gamifies choosing a pet.",
Â  Â  Â  Â  Â  Â  "A one-page music festival schedule with neon visuals.",
Â  Â  Â  Â  Â  Â  "An AI art generator website with live previews"
Â  Â  Â  Â  ];

Â  Â  Â  Â  let promptTypingIndex = 0;Â 
Â  Â  Â  Â  let charIndex = 0;
Â  Â  Â  Â  let isDeleting = false;
Â  Â  Â  Â  const typingSpeed = 75;Â 
Â  Â  Â  Â  const deletingSpeed = 40;Â 
Â  Â  Â  Â  const delayBetweenPrompts = 2000;Â 
Â  Â  Â  Â  const defaultPlaceholder = "e.g., 'A vibrant landing page for a dog grooming salon called Paws & Claws, focusing on luxury services and online booking.'";

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Handles the cycling and typing effect for the placeholder.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function typePlaceholderEffect() {
Â  Â  Â  Â  Â  Â  // Stop the effect if the user has started typing
Â  Â  Â  Â  Â  Â  if (promptInput.value.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const currentPrompt = placeholderPrompts[promptTypingIndex];
Â  Â  Â  Â  Â  Â  let placeholderText = promptInput.getAttribute('placeholder') || '';

Â  Â  Â  Â  Â  Â  if (isDeleting) {
Â  Â  Â  Â  Â  Â  Â  Â  // DELETE PHASE
Â  Â  Â  Â  Â  Â  Â  Â  placeholderText = currentPrompt.substring(0, charIndex - 1);
Â  Â  Â  Â  Â  Â  Â  Â  charIndex--;
Â  Â  Â  Â  Â  Â  Â  Â  if (charIndex === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isDeleting = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  promptTypingIndex = (promptTypingIndex + 1) % placeholderPrompts.length;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(typePlaceholderEffect, 500); // Small pause after deletion
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // TYPING PHASE
Â  Â  Â  Â  Â  Â  Â  Â  placeholderText = currentPrompt.substring(0, charIndex + 1);
Â  Â  Â  Â  Â  Â  Â  Â  charIndex++;
Â  Â  Â  Â  Â  Â  Â  Â  if (charIndex === currentPrompt.length) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isDeleting = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(typePlaceholderEffect, delayBetweenPrompts); // Long pause at the end
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Apply the new text
Â  Â  Â  Â  Â  Â  promptInput.setAttribute('placeholder', placeholderText);

Â  Â  Â  Â  Â  Â  // Calculate the next delay
Â  Â  Â  Â  Â  Â  const speed = isDeleting ? deletingSpeed : typingSpeed;
Â  Â  Â  Â  Â  Â  setTimeout(typePlaceholderEffect, speed);
Â  Â  Â  Â  }

Â  Â  Â  Â  // Add an input listener to stop the animation when the user starts typing
Â  Â  Â  Â  // and to restart it if the user clears the input.
Â  Â  Â  Â  promptInput.addEventListener('input', () => {
Â  Â  Â  Â  Â  Â  Â if (promptInput.value.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â // User started typing, set the placeholder back to the default hint
Â  Â  Â  Â  Â  Â  Â  Â  Â promptInput.setAttribute('placeholder', defaultPlaceholder);Â 
Â  Â  Â  Â  Â  Â  Â } else if (promptInput.value.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â // User cleared the input, restart the effect
Â  Â  Â  Â  Â  Â  Â  Â  Â // Reset the internal state to start from the beginning of the next prompt
Â  Â  Â  Â  Â  Â  Â  Â  Â promptTypingIndex = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â charIndex = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â isDeleting = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â typePlaceholderEffect();Â 
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â });


Â  Â  Â  Â  // ------------------------------------------------------------------
Â  Â  Â  Â  // â­ CODE FOR TYPING PLACEHOLDER EFFECT ENDS HERE â­
Â  Â  Â  Â  // ------------------------------------------------------------------


Â  Â  Â  Â  // --- Authentication Guard and Event Listeners ---

Â  Â  Â  Â  onAuthStateChanged(auth, (user) => {
Â  Â  Â  Â  Â  Â  console.log("Auth state resolved. User:", user ? user.email : "none");

Â  Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  Â  Â  currentUserId = user.uid; // Store the user ID
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // User is logged in: Show the content
Â  Â  Â  Â  Â  Â  Â  Â  loadingState.style.pointerEvents = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  loadingState.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  loadingState.style.opacity = '0';Â 
Â  Â  Â  Â  Â  Â  Â  Â  mainContent.classList.remove('hidden');

Â  Â  Â  Â  Â  Â  Â  Â  if (!listenersAttached) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  generateBtn.addEventListener('click', handleGeneration);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refineBtn.addEventListener('click', handleRefine);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  copyBtn.addEventListener('click', () => copyToClipboard(outputCode.textContent));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  downloadBtn.addEventListener('click', handleDownload);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previewBtn.addEventListener('click', handlePreview);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logoutBtn.addEventListener('click', async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await signOut(auth);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Logout failed:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // â­ START THE TYPING EFFECT HERE AFTER AUTHENTICATION IS COMPLETE â­
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  typePlaceholderEffect();Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  listenersAttached = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // User is NOT logged in: Redirect them to login.
Â  Â  Â  Â  Â  Â  Â  Â  console.log("User not authenticated. Redirecting to login.");
Â  Â  Â  Â  Â  Â  Â  Â  const currentPath = window.location.pathname;
Â  Â  Â  Â  Â  Â  Â  Â  const redirectUrl = 'login.html?redirect=' + encodeURIComponent(currentPath);
Â  Â  Â  Â  Â  Â  Â  Â  window.location.replace(redirectUrl);Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  lucide.createIcons();
Â  Â  </script>
</body>
</html>
