<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ammoue | AI Site Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .text-ammoue { color: #0d9488; }
        .bg-ammoue { background-color: #0d9488; }

        /* Loading state overlay */
        .loading-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        /* Custom scrollbar for the code block */
        #html-output-code::-webkit-scrollbar { width: 6px; }
        #html-output-code::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="antialiased min-h-screen">

    <!-- Loading Screen (Visible until auth state is confirmed) -->
    <div id="loading-screen" class="loading-screen">
        <svg class="animate-spin h-8 w-8 text-ammoue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <!-- Message Box for alerts (replaces alert()) -->
    <div id="message-box" class="p-4 rounded-xl shadow-2xl text-white font-semibold fixed top-4 left-1/2 transform -translate-x-1/2 opacity-0 transition-opacity duration-300 z-50"></div>


    <!-- Main Content (Hidden initially, shown only AFTER auth is confirmed) -->
    <div id="main-content" class="min-h-screen hidden transition-opacity duration-500">
        <!-- Header/Navbar -->
        <nav class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
            <div class="text-2xl font-extrabold text-ammoue">AI Site Generator</div>
            <div class="flex items-center space-x-4">
                <a href="dashboard.html" class="px-3 py-2 text-sm font-medium rounded-xl text-gray-700 bg-gray-100 hover:bg-gray-200 transition duration-150 shadow-sm">
                    <i data-lucide="layout-grid" class="w-4 h-4 inline-block mr-1"></i> Dashboard
                </a>
                <button onclick="handleLogout()" class="px-3 py-2 text-sm font-medium rounded-xl text-white bg-red-500 hover:bg-red-600 transition duration-150 shadow-md">
                    Log Out
                </button>
            </div>
        </nav>

        <!-- Main Generation Area -->
        <main class="p-4 md:p-8 max-w-7xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Describe Your Dream Website</h1>

            <!-- Input and Action Controls -->
            <div class="bg-white p-6 rounded-2xl shadow-xl mb-8">
                <label for="prompt-input" class="block text-lg font-semibold text-gray-700 mb-3">Prompt:</label>
                <textarea id="prompt-input" rows="4"
                    class="w-full p-4 border border-gray-300 rounded-xl focus:ring-ammoue focus:border-ammoue resize-none transition duration-150"
                    placeholder="E.g., A single-page, fully responsive website for a modern coffee shop called 'The Daily Grind'. Use dark mode with subtle gold accents, a large hero image, and a simple menu with prices."></textarea>
                
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3 mt-4">
                    <button id="generate-button" onclick="handleGenerate()"
                        class="flex-1 px-6 py-3 text-lg font-bold rounded-xl text-white bg-ammoue hover:bg-teal-700 transition duration-150 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                        <i data-lucide="sparkles" class="w-5 h-5 inline-block mr-2"></i> Generate Site
                    </button>
                    <input type="text" id="project-title" placeholder="Project Title (e.g., Coffee Shop Site)"
                           class="sm:w-1/3 p-3 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500">
                    <button id="save-button" onclick="handleSaveProject()"
                        class="sm:w-1/4 px-6 py-3 text-lg font-bold rounded-xl text-white bg-blue-600 hover:bg-blue-700 transition duration-150 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center" disabled>
                        <i data-lucide="save" class="w-5 h-5 inline-block mr-2"></i> Save Project
                    </button>
                </div>
            </div>
            
            <!-- Output Area -->
            <div id="output-area" class="space-y-6 hidden">
                <h2 class="text-2xl font-bold text-gray-800">Generated Code & Preview</h2>

                <!-- Tabs for Code and Preview -->
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                    <div class="flex border-b border-gray-200">
                        <button id="tab-code" onclick="switchTab('code')" class="px-6 py-3 text-sm font-semibold border-b-2 border-ammoue text-ammoue transition duration-150">HTML Code</button>
                        <button id="tab-preview" onclick="switchTab('preview')" class="px-6 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition duration-150">Live Preview</button>
                    </div>

                    <!-- Code Block -->
                    <div id="content-code" class="p-4" style="height: 500px;">
                        <pre id="html-output-code" class="bg-gray-50 p-4 rounded-xl text-xs overflow-auto h-full text-gray-800 border border-gray-200"></pre>
                    </div>

                    <!-- Live Preview Iframe -->
                    <div id="content-preview" class="p-4 hidden bg-gray-100" style="height: 500px;">
                        <iframe id="html-output-preview" class="w-full h-full bg-white border border-gray-300 rounded-xl shadow-inner"></iframe>
                    </div>
                </div>

                <!-- Source Information -->
                <div id="source-info" class="p-4 bg-gray-100 rounded-xl text-sm text-gray-600 hidden">
                    <p class="font-semibold mb-2 flex items-center"><i data-lucide="link" class="w-4 h-4 mr-2"></i> Grounding Sources:</p>
                    <ul id="source-list" class="list-disc pl-5 space-y-1">
                        <!-- Sources will be injected here -->
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase and AI Logic -->
    <script type="module">
        // Using SDK v12.4.0 to match dashboard.html imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // IMPORTANT: Hardcoded configuration from login.html/dashboard.html for consistency
        const firebaseConfig = {
            apiKey: "AIzaSyAmnZ69YDcEFcmuXIhmGxDUSPULxpI-Bmg",
            authDomain: "ammoueai.firebaseapp.com",
            projectId: "ammoueai",
            storageBucket: "ammoueai.firebasestorage.app",
            messagingSenderId: "135818868149",
            appId: "1:135818868149:web:db9280baf9540a3339d5fc",
        };
        
        // --- Firebase Globals ---
        let auth = null;
        let db = null;
        let currentUserId = null;
        const appId = firebaseConfig.projectId; // Use projectId as a substitute for __app_id

        // --- API Globals ---
        // CORRECTED: Using the secure internal proxy endpoint which resolves to 
        // /api/generate on the same domain (e.g., Vercel Serverless Function).
        const apiUrl = '/api/generate'; 

        // --- DOM Elements ---
        const loadingScreen = document.getElementById('loading-screen');
        const mainContent = document.getElementById('main-content');
        const msgBox = document.getElementById('message-box');
        const promptInput = document.getElementById('prompt-input');
        const generateButton = document.getElementById('generate-button');
        const saveButton = document.getElementById('save-button');
        const outputArea = document.getElementById('output-area');
        const htmlOutputCode = document.getElementById('html-output-code');
        const htmlOutputPreview = document.getElementById('html-output-preview');
        const projectTitleInput = document.getElementById('project-title');
        const sourceInfo = document.getElementById('source-info');
        const sourceList = document.getElementById('source-list');

        let lastGeneratedHtml = '';
        let lastUserPrompt = '';

        // --- Utility Functions ---

        function showMessage(message, isError) {
            if (!msgBox) return;
            msgBox.textContent = message;

            msgBox.className = 'p-4 rounded-xl shadow-2xl text-white font-semibold fixed top-4 left-1/2 transform -translate-x-1/2 transition-opacity duration-300 z-50';
            msgBox.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
            msgBox.classList.add('opacity-100');
            setTimeout(() => { msgBox.classList.remove('opacity-100'); }, 4000);
        }

        function setGenerating(isGenerating) {
            generateButton.disabled = isGenerating;
            saveButton.disabled = isGenerating || !lastGeneratedHtml;
            generateButton.innerHTML = isGenerating ? 
                '<svg class="animate-spin h-5 w-5 text-white mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating...' : 
                '<i data-lucide="sparkles" class="w-5 h-5 inline-block mr-2"></i> Generate Site';
            lucide.createIcons(); // Re-render icons after button text change
        }

        /** Switches between Code and Live Preview tabs */
        window.switchTab = function(tab) {
            const tabCode = document.getElementById('tab-code');
            const tabPreview = document.getElementById('tab-preview');
            const contentCode = document.getElementById('content-code');
            const contentPreview = document.getElementById('content-preview');

            tabCode.classList.remove('border-ammoue', 'text-ammoue');
            tabPreview.classList.remove('border-ammoue', 'text-ammoue');
            tabCode.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700');
            tabPreview.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700');

            if (tab === 'code') {
                tabCode.classList.add('border-ammoue', 'text-ammoue');
                tabCode.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700');
                contentCode.classList.remove('hidden');
                contentPreview.classList.add('hidden');
            } else {
                tabPreview.classList.add('border-ammoue', 'text-ammoue');
                tabPreview.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700');
                contentCode.classList.add('hidden');
                contentPreview.classList.remove('hidden');
            }
        }
        
        /** Renders the generated HTML into the code block and iframe preview */
        function renderOutput(html, sources) {
            lastGeneratedHtml = html;
            
            // 1. Update Code Block
            htmlOutputCode.textContent = html;
            
            // 2. Update Live Preview Iframe
            htmlOutputPreview.contentDocument.open();
            htmlOutputPreview.contentDocument.write(html);
            htmlOutputPreview.contentDocument.close();

            // 3. Update Sources (Grounding data is typically handled server-side when using a proxy, 
            // but we keep the structure here just in case the proxy forwards it.)
            if (sources && sources.length > 0) {
                sourceList.innerHTML = sources.map(s => 
                    `<li><a href="${s.uri}" target="_blank" class="text-blue-600 hover:text-blue-800 truncate block">${s.title}</a></li>`
                ).join('');
                sourceInfo.classList.remove('hidden');
            } else {
                sourceInfo.classList.add('hidden');
            }

            outputArea.classList.remove('hidden');
            saveButton.disabled = false;
        }
        
        /** Calls the proxied /api/generate endpoint to generate the HTML content */
        window.handleGenerate = async function() {
            const userQuery = promptInput.value.trim();
            if (!userQuery) {
                showMessage("Please enter a description for your website.", true);
                return;
            }
            lastUserPrompt = userQuery;
            lastGeneratedHtml = '';
            setGenerating(true);
            outputArea.classList.add('hidden'); // Hide output while generating
            
            // System instruction to enforce single-file HTML and Tailwind CSS usage
            const systemPrompt = `You are an expert front-end developer. Your task is to generate a complete, beautiful, and fully responsive single-file HTML web page based on the user's description. You must use Tailwind CSS for all styling, which is loaded via the CDN script tag. The final output MUST be only the raw HTML code, starting with <!DOCTYPE html> and ending with </html>. Do NOT include markdown code fences (like \`\`\`html) in the final response. Ensure the design is modern, visually appealing, and works perfectly on mobile and desktop. Use the 'Inter' font.`;
            
            // Payload structure for the proxied endpoint
            const payload = {
                model: 'gemini-2.5-flash-preview-05-20',
                prompt: userQuery,
                systemInstruction: systemPrompt,
                tools: [{ "google_search": {} }],
            };

            const maxRetries = 5;
            let delay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, { // Using the secure local path
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2;
                            continue;
                        }
                        throw new Error(`Proxy API call failed with status: ${response.status}`);
                    }

                    // Assuming the proxied endpoint returns a clean JSON object 
                    // with 'text' and potentially 'sources'.
                    const result = await response.json();
                    
                    if (result && result.text) {
                        const htmlText = result.text;
                        const sources = result.sources || []; // Assuming sources are forwarded if available

                        renderOutput(htmlText, sources);
                        showMessage("Website generated successfully!", false);
                        setGenerating(false);
                        return; // Exit function on success
                    } else {
                        throw new Error("Proxy API response was empty or malformed.");
                    }
                } catch (error) {
                    console.error("Generate API Error:", error);
                    if (i === maxRetries - 1) {
                         showMessage(`Failed to generate content after ${maxRetries} tries. ${error.message}`, true);
                         setGenerating(false);
                         return; // Exit function after final failure
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        /**
         * Saves the generated project to Firestore.
         */
        window.handleSaveProject = async function() {
            if (!lastGeneratedHtml) {
                showMessage("Nothing to save. Please generate a site first.", true);
                return;
            }

            const title = projectTitleInput.value.trim() || 'Untitled AI Project';
            
            // Disable button during save process
            saveButton.disabled = true;
            saveButton.textContent = "Saving...";

            try {
                // 1. Define the collection path for the current authenticated user's projects
                // Path: /artifacts/{appId}/users/{userId}/projects
                const projectsCollectionRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'projects');

                // 2. Create the project document data
                const projectData = {
                    title: title,
                    prompt: lastUserPrompt,
                    htmlContent: lastGeneratedHtml,
                    timestamp: new Date().toISOString() // Use ISO string for consistent sorting
                };

                // 3. Save the document to Firestore
                await addDoc(projectsCollectionRef, projectData);

                showMessage(`Project "${title}" saved successfully!`, false);
                projectTitleInput.value = ''; // Clear title input after saving

            } catch (error) {
                console.error("Error saving project to Firestore:", error);
                showMessage("Failed to save project. Check console for details.", true);
            } finally {
                // Re-enable the button and restore text
                saveButton.textContent = "Save Project";
                saveButton.disabled = false; 
                lucide.createIcons();
            }
        }

        /** Initializes Firebase services and sets up the critical auth listener. */
        function initializeAppAndAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // CRITICAL: Authentication Gate using the listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // **SUCCESS** - User is authenticated
                        currentUserId = user.uid;

                        // Show main content
                        loadingScreen.classList.add('hidden');
                        mainContent.classList.remove('hidden');
                        mainContent.classList.add('opacity-100');
                        saveButton.disabled = true; // Initially disabled until content is generated
                    } else {
                        // **FAILURE** - User is NOT authenticated: Redirect to login page
                        console.log("No valid session found. Redirecting to login.html...");
                        window.location.href = 'login.html';
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage("Initialization error. Redirecting to login...", true);
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 500);
            }
        }

        /** Logs the current user out. */
        window.handleLogout = async function() {
            if (auth) {
                try {
                    await signOut(auth);
                    showMessage("You have been signed out.", false);
                    // The onAuthStateChanged listener handles the subsequent redirect to login.html
                } catch (error) {
                    console.error("Logout failed:", error);
                    showMessage("Logout failed. Please try again.", true);
                }
            } else {
                window.location.href = 'login.html';
            }
        }

        // --- Run Initialization Immediately ---
        initializeAppAndAuth();
        lucide.createIcons();
        switchTab('code'); // Default to showing the code tab

    </script>
</body>
</html>
