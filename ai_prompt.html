<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ammoue | AI Site Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .text-ammoue { color: #0d9488; }
        .bg-ammoue { background-color: #0d9488; }
        /* Style to ensure the loading screen covers the whole view */
        #loading-state {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            z-index: 100;
            /* Added transition for smoother removal */
            transition: opacity 0.3s ease-in-out; 
        }
        /* Custom styles for message box */
        #message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="antialiased min-h-screen">

    <!-- Message Box for alerts (replaces alert()) -->
    <div id="message-box" class="p-4 rounded-xl shadow-2xl text-white font-semibold"></div>

    <!-- 1. LOADING STATE (Visible until Auth Check is Complete) -->
    <div id="loading-state">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-8 w-8 text-ammoue mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-600 font-medium">Verifying session...</p>
        </div>
    </div>

    <!-- 2. MAIN CONTENT (Hidden until Auth Check is Complete) -->
    <div id="main-content" class="max-w-4xl mx-auto p-6 lg:p-10 hidden">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-4">Generate Your AI Website</h1>
        <p class="text-xl text-gray-500 mb-8">Tell Ammoue exactly what website you want to generate (e.g., 'A modern portfolio site for a UX designer with a dark theme').</p>

        <textarea id="ai-prompt" rows="6" class="w-full p-4 border-2 border-ammoue/30 rounded-2xl focus:ring-ammoue focus:border-ammoue transition duration-150 shadow-md" placeholder="e.g., 'A vibrant landing page for a dog grooming salon called Paws & Claws, focusing on luxury services and online booking.'"></textarea>

        <div class="mt-6 flex justify-end space-x-4">
            <!-- NEW Save Project Button -->
            <button id="save-btn" class="px-6 py-3 text-base font-semibold rounded-xl text-white bg-blue-600 hover:bg-blue-700 transition duration-300 flex items-center disabled:opacity-50" disabled>
                <i data-lucide="save" class="w-4 h-4 mr-1"></i> Save Draft
            </button>
            <!-- Dashboard Button -->
            <a id="dashboard-link" href="dashboard.html" class="px-6 py-3 text-base font-semibold rounded-xl text-gray-600 border border-gray-300 hover:bg-gray-100 transition duration-300 flex items-center">
                <i data-lucide="layout-dashboard" class="w-4 h-4 mr-1"></i> Dashboard
            </a>
            <button id="logout-btn" class="px-6 py-3 text-base font-semibold rounded-xl text-gray-600 border border-gray-300 hover:bg-gray-100 transition duration-300">
                Log Out
            </button>
            <button id="generate-btn" class="px-8 py-3 text-lg font-bold rounded-xl text-white bg-ammoue hover:bg-teal-700 transition duration-300 shadow-lg shadow-teal-500/30 transform hover:scale-[1.01]">
                Generate HTML Code
            </button>
        </div>

        <div id="generation-output" class="mt-12 p-6 bg-white border border-gray-100 rounded-2xl shadow-lg hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800 flex items-center">
                    <i data-lucide="code" class="w-5 h-5 mr-2 text-ammoue"></i>
                    Generated HTML Code
                </h3>
                <button id="copy-btn" class="text-sm font-medium text-ammoue hover:text-teal-600 flex items-center transition duration-200">
                    <i data-lucide="copy" class="w-4 h-4 mr-1"></i> Copy Code
                </button>
            </div>
            
            <!-- Code Block for Display -->
            <pre class="bg-gray-100 p-4 rounded-xl overflow-x-auto border border-gray-300 text-sm">
                <code id="output-code" class="whitespace-pre"></code>
            </pre>
            
            <div class="flex mt-4">
                <!-- Preview Button -->
                <button id="preview-btn" class="px-6 py-2 text-base font-semibold rounded-xl text-white bg-blue-600 hover:bg-blue-700 transition duration-300">
                    Preview Site (Will open in a new tab)
                </button>
                
                <!-- Download Button -->
                <button id="download-btn" class="ml-4 px-6 py-2 text-base font-semibold rounded-xl text-white bg-green-600 hover:bg-green-700 transition duration-300 flex items-center justify-center">
                    <i data-lucide="download" class="w-5 h-5 mr-2"></i> Download HTML
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase and AI Generation Logic -->
    <script type="module">
        // --- MANDATORY FIREBASE IMPORTS (v11.6.1) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL CONFIGURATION (MANDATORY INJECTED VARIABLES) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Initialize Firebase and Auth ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- DOM Elements ---
        const loadingState = document.getElementById('loading-state');
        const mainContent = document.getElementById('main-content');
        const logoutBtn = document.getElementById('logout-btn');
        const generateBtn = document.getElementById('generate-btn');
        const saveBtn = document.getElementById('save-btn'); // NEW: Save Button
        const promptInput = document.getElementById('ai-prompt');
        const outputDiv = document.getElementById('generation-output');
        const outputCode = document.getElementById('output-code');
        const copyBtn = document.getElementById('copy-btn');
        const previewBtn = document.getElementById('preview-btn');
        const messageBox = document.getElementById('message-box');
        const downloadBtn = document.getElementById('download-btn');

        // Flag to ensure listeners are only attached once after successful authentication
        let listenersAttached = false;
        let userId = null; // To store the authenticated user ID
        const DRAFT_DOC_ID = 'current_draft'; // Fixed document ID for the working draft

        // --- Utility Functions ---

        /**
         * Generates the path for the current user's draft document in Firestore.
         */
        function getDraftDocRef() {
            if (!userId) {
                console.error("User ID is not set. Cannot get Firestore reference.");
                return null;
            }
            // Private data path: /artifacts/{appId}/users/{userId}/generated_sites/current_draft
            return doc(db, `artifacts/${appId}/users/${userId}/generated_sites/${DRAFT_DOC_ID}`);
        }

        /**
         * Displays a temporary, custom message box.
         */
        function showMessage(message, isError) {
            messageBox.textContent = message;
            
            if (isError) {
                messageBox.classList.remove('bg-green-500', 'bg-ammoue');
                messageBox.classList.add('bg-red-500');
            } else {
                messageBox.classList.remove('bg-red-500');
                messageBox.classList.add('bg-ammoue'); // Use brand color for success
            }

            messageBox.classList.remove('opacity-0');
            messageBox.classList.add('opacity-100');

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
            }, 4000);
        }

        /**
         * Sets the loading state on the generate button.
         */
        function setLoading(isLoading) {
            if (isLoading) {
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating...';
            } else {
                generateBtn.disabled = false;
                generateBtn.innerHTML = 'Generate HTML Code';
            }
        }

        /**
         * Utility function to copy text to clipboard.
         */
        function copyToClipboard(text) {
            try {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showMessage("Code copied to clipboard!", false);
            } catch (err) {
                console.error('Failed to copy text:', err);
                showMessage("Failed to copy code.", true);
            }
        }
        
        /**
         * Opens the generated HTML in a new window for a live preview.
         */
        function handlePreview() {
            const htmlContent = previewBtn.dataset.html;
            if (!htmlContent) {
                showMessage("No HTML code available to preview.", true);
                return;
            }

            const previewWindow = window.open('', '_blank');
            if (!previewWindow) {
                 showMessage("Pop-ups must be enabled to view the preview.", true);
                 return;
            }

            previewWindow.document.write(htmlContent);
            previewWindow.document.close();
        }

        /**
         * Downloads the generated HTML code as a file.
         */
        function handleDownload() {
            const code = outputCode.textContent;
            if (!code) {
                showMessage("Nothing to download. Please generate code first.", true);
                return;
            }

            const blob = new Blob([code], { type: 'text/html' });
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'ammoue_generated_site.html'; 
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showMessage("HTML file prepared for download!", false);
        }

        // --- FIRESTORE PERSISTENCE LOGIC ---

        /**
         * Saves the current prompt and generated code to Firestore as the user's draft.
         */
        async function handleSave() {
            const draftRef = getDraftDocRef();
            const htmlCode = outputCode.textContent;
            const prompt = promptInput.value.trim();

            if (!draftRef) {
                showMessage("Error: User session not ready to save.", true);
                return;
            }
            
            if (!htmlCode && prompt.length === 0) {
                showMessage("Nothing to save.", false);
                return;
            }

            saveBtn.disabled = true;
            saveBtn.innerHTML = '<svg class="animate-spin h-4 w-4 mr-1 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Saving...';
            
            const draftData = {
                prompt: prompt,
                htmlCode: htmlCode,
                timestamp: Date.now()
            };

            try {
                await setDoc(draftRef, draftData);
                showMessage("Draft saved successfully!", false);
            } catch (error) {
                console.error("Failed to save draft:", error);
                showMessage("Failed to save draft. Check console for details.", true);
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i data-lucide="save" class="w-4 h-4 mr-1"></i> Save Draft';
                lucide.createIcons(); // Re-render icon
            }
        }

        /**
         * Loads the user's last saved draft from Firestore on page load.
         */
        async function loadDraft() {
            const draftRef = getDraftDocRef();
            if (!draftRef) return;

            try {
                const docSnap = await getDoc(draftRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    promptInput.value = data.prompt || '';
                    
                    if (data.htmlCode) {
                        outputCode.textContent = data.htmlCode;
                        previewBtn.dataset.html = data.htmlCode;
                        outputDiv.classList.remove('hidden');
                        showMessage("Loaded previous draft!", false);
                    } else {
                        outputDiv.classList.add('hidden');
                        showMessage("Loaded previous prompt.", false);
                    }
                } else {
                    console.log("No previous draft found for this user.");
                    outputDiv.classList.add('hidden');
                }
            } catch (error) {
                console.error("Failed to load draft:", error);
                showMessage("Failed to load previous draft.", true);
            }
        }


        // --- AI Generation Logic ---

        /**
         * Handles the generation process by calling the Gemini API.
         */
        async function handleGeneration() {
            const prompt = promptInput.value.trim();
            if (prompt.length < 10) {
                showMessage("Please provide a more detailed prompt (at least 10 characters).", true);
                return;
            }

            setLoading(true);
            outputDiv.classList.add('hidden');
            outputCode.textContent = ''; // Clear previous output
            
            // System instruction to guide the model to output a single, complete HTML file
            const systemPrompt = "You are an expert AI site generator. Based ONLY on the user's request, generate a single, complete, modern, responsive HTML file that uses Tailwind CSS (via its CDN link) and includes all necessary CSS and JavaScript within that single file. The output MUST be only the raw HTML code, starting with <!DOCTYPE html> and ending with </html>. Make it look beautiful and fully responsive, designed for mobile first.";
            const userQuery = `Generate an HTML website based on this prompt: ${prompt}`;
            
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        const errorMessage = result.error?.message || response.statusText || "Unknown API error.";
                        throw new Error(`API Error [Status: ${response.status}]: ${errorMessage}`);
                    }

                    const generatedHtml = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (generatedHtml) {
                        // Sanitize and display the HTML code
                        outputCode.textContent = generatedHtml.trim();
                        
                        // Set the preview button data
                        previewBtn.dataset.html = generatedHtml.trim();

                        outputDiv.classList.remove('hidden');
                        showMessage("HTML generated successfully! Now saving the draft...", false);
                        
                        // IMPLICIT SAVE: Automatically save the new generation as the current draft
                        await handleSave(); 

                        break; // Exit loop on success
                    } else {
                        throw new Error("API response missing generated content.");
                    }

                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error.message);
                    if (attempt === maxRetries - 1) {
                        showMessage(`Generation failed: ${error.message}. Please try again later.`, true);
                    } else {
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            setLoading(false);
        }


        // --- Authentication Guard and Event Listeners ---

        /**
         * Authenticates the user using the initial custom token or anonymously.
         */
        async function authenticateUser() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Authentication failed:", error);
            }
        }
        
        // Initial authentication call
        authenticateUser();


        /**
         * The crucial Auth Guard that waits for the user's status.
         */
        onAuthStateChanged(auth, (user) => {
            console.log("Auth state resolved. User:", user ? user.uid : "none");

            if (user) {
                // User is logged in: Set user ID, load draft, and show content
                userId = user.uid; // Set global userId
                
                // CRITICAL: Disable pointer events on the overlay immediately
                loadingState.style.pointerEvents = 'none';

                // 1. Hide loading screen immediately
                loadingState.classList.add('hidden');
                loadingState.style.opacity = '0';
                
                // 2. Show main content immediately
                mainContent.classList.remove('hidden');

                // 3. Load previous draft (handles persistence)
                loadDraft();
                
                // 4. Attach event listeners only once
                if (!listenersAttached) {
                    generateBtn.addEventListener('click', handleGeneration);
                    saveBtn.addEventListener('click', handleSave); // NEW: Save listener
                    copyBtn.addEventListener('click', () => copyToClipboard(outputCode.textContent));
                    previewBtn.addEventListener('click', handlePreview);
                    downloadBtn.addEventListener('click', handleDownload);
                    
                    logoutBtn.addEventListener('click', async () => {
                        try {
                            await signOut(auth);
                            // Redirect handled by the 'else' block below
                        } catch (error) {
                            console.error("Logout failed:", error);
                        }
                    });
                    listenersAttached = true;
                    console.log("Event listeners successfully attached.");
                }


            } else {
                // User is NOT logged in (after a sign out or initial check with no token): Redirect them to login.
                if (userId !== null) { // Only redirect if we were previously logged in or if it's the final unauthenticated state
                    console.log("User not authenticated. Redirecting to login.");
                    const currentPath = window.location.pathname;
                    const redirectUrl = 'login.html?redirect=' + encodeURIComponent(currentPath);
                    window.location.replace(redirectUrl);
                }
            }
        });
        
        lucide.createIcons();
    </script>
</body>
</html>
