<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ammoue | User Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .text-ammoue { color: #0d9488; }
        .bg-ammoue { background-color: #0d9488; }

        /* CRITICAL: Loading state overlay */
        .loading-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        /* Custom style for multi-line text truncation */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            overflow: hidden;
            -webkit-line-clamp: 2;
        }
    </style>
</head>
<body class="antialiased min-h-screen">

    <div id="loading-screen" class="loading-screen">
        <svg class="animate-spin h-8 w-8 text-ammoue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <div id="message-box" class="p-4 rounded-xl shadow-2xl text-white font-semibold fixed top-4 left-1/2 transform -translate-x-1/2 opacity-0 transition-opacity duration-300 z-50"></div>


    <div id="dashboard-content" class="min-h-screen hidden transition-opacity duration-500">
        <nav class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
            <div class="text-2xl font-extrabold text-ammoue">Ammoue Dashboard</div>
            <div class="flex items-center space-x-4">
                <span class="text-gray-600 text-sm">Welcome, <span id="user-email" class="font-semibold">Loading...</span></span>
                <button onclick="handleLogout()" class="px-3 py-2 text-sm font-medium rounded-xl text-white bg-red-500 hover:bg-red-600 transition duration-150 shadow-md">
                    Log Out
                </button>
            </div>
        </nav>

        <main class="p-4 md:p-8 max-w-6xl mx-auto">
            <h1 class="text-4xl font-bold text-gray-800 mb-6">Your Sites & Projects</h1>

            <div id="projects-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">

                <div onclick="window.location.href='ai_prompt.html'"
                    class="bg-white border-2 border-dashed border-gray-300 rounded-2xl p-6 flex flex-col items-center justify-center text-center hover:border-ammoue transition duration-300 cursor-pointer hover:shadow-lg h-full min-h-[200px]">
                    <i data-lucide="plus-circle" class="w-12 h-12 text-gray-400 mb-3"></i>
                    <p class="text-lg font-semibold text-gray-700">Create New AI Site</p>
                    <p class="text-sm text-gray-500 mt-1">Start generating a new website</p>
                </div>

                <p id="no-projects-message" class="col-span-full text-center text-gray-500 text-lg hidden mt-10">
                    You haven't saved any projects yet. Click above to start!
                </p>

            </div>
        </main>
    </div>

 <script type="module">
    // Using SDK v12.4.0 to match your previous setup
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, query, deleteDoc, doc, Timestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // IMPORTANT: Hardcoded configuration from login.html for this specific app instance
    const firebaseConfig = {
        apiKey: "AIzaSyAmnZ69YDcEFcmuXIhmGxDUSPULxpI-Bmg",
        authDomain: "ammoueai.firebaseapp.com",
        projectId: "ammoueai",
        storageBucket: "ammoueai.firebasestorage.app",
        messagingSenderId: "135818868149",
        appId: "1:135818868149:web:db9280baf9540a3339d5fc",
    };

    let auth = null;
    let db = null;
    let currentUserId = null;
    let isAuthReady = false;
    const appId = firebaseConfig.projectId;

    // --- DOM Elements ---
    const loadingScreen = document.getElementById('loading-screen');
    const dashboardContent = document.getElementById('dashboard-content');
    const userEmailSpan = document.getElementById('user-email');
    const msgBox = document.getElementById('message-box');
    const projectsContainer = document.getElementById('projects-container');


    // --- Utility Functions ---

    /**
     * Converts raw code (like HTML or JS) into a displayable string
     * by escaping HTML special characters.
     */
    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe.replace(/&/g, "&amp;")
                     .replace(/</g, "&lt;")
                     .replace(/>/g, "&gt;")
                     .replace(/"/g, "&quot;")
                     .replace(/'/g, "&#039;");
    }

    /** Shows a temporary message box (replaces alert()) */
    function showMessage(message, isError) {
        if (!msgBox) return;
        msgBox.textContent = message;

        msgBox.className = 'p-4 rounded-xl shadow-2xl text-white font-semibold fixed top-4 left-1/2 transform -translate-x-1/2 transition-opacity duration-300 z-50';
        msgBox.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
        msgBox.classList.add('opacity-100');
        setTimeout(() => { msgBox.classList.remove('opacity-100'); }, 4000);
    }

    /** Opens the generated HTML in a new window for a live preview. 
     * // **FIXED/UPDATED** to decode Base64 content
     */
    window.handlePreview = function(encodedHtmlContent) {
        if (!encodedHtmlContent) {
            showMessage("Preview data is missing.", true);
            return;
        }

        // Decode the Base64 string back to HTML content
        const htmlContent = atob(encodedHtmlContent); 

        const previewWindow = window.open('', '_blank');
        if (!previewWindow) {
             showMessage("Pop-ups must be enabled to view the preview.", true);
             return;
        }
        previewWindow.document.write(htmlContent);
        previewWindow.document.close();
    }

    /** Downloads the generated HTML code as a file. 
     * // **FIXED/UPDATED** to decode Base64 content and parse title
     */
    window.handleDownload = function(encodedHtmlContent, title) {
        if (!encodedHtmlContent) {
            showMessage("Nothing to download.", true);
            return;
        }
        
        // Decode the Base64 string back to HTML content
        const htmlContent = atob(encodedHtmlContent); 
        
        // Title was JSON.stringify'd, so parse it back
        const cleanTitle = JSON.parse(title); 

        const blob = new Blob([htmlContent], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        const filename = cleanTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'ammoue_project';
        a.download = `${filename}.html`;

        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        showMessage("HTML file prepared for download!", false);
    }

    /** Handles deletion of a project from Firestore. */
    window.handleDeleteProject = async function(projectId) {
        if (!isAuthReady || !currentUserId) {
            showMessage("System not ready or user ID missing.", true);
            return;
        }

        // Simple confirmation before delete
        if (!confirm("Are you sure you want to delete this project? This cannot be undone.")) {
            return;
        }

        showMessage("Initiating project deletion...", false);
        
        try {
            // Document path: /artifacts/{appId}/users/{userId}/projects/{projectId}
            const docRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'projects', projectId);
            await deleteDoc(docRef);
            showMessage("Project deleted successfully!", false);
        } catch (error) {
            console.error("Error deleting document:", error);
            showMessage("Failed to delete project.", true);
        }
    }

    /** Renders the list of projects from Firestore data. */
    function renderProjects(projects) {
        // Get the HTML of the static 'Create New Site' card
        const createCardElement = projectsContainer.querySelector('div.cursor-pointer');
        
        if (!createCardElement) {
            console.error("Could not find the static 'Create New Site' element.");
            projectsContainer.innerHTML = `<p class="col-span-full text-center text-red-500 text-lg mt-10">Error: Missing Create Site element.</p>`;
            return;
        }
        
        const createCardHtml = createCardElement.outerHTML;

        // Start HTML with the static 'Create New Site' card
        let projectsHtml = createCardHtml;

        if (projects.length === 0) {
            // Keep the 'Create New Site' card and show the empty message
            projectsContainer.innerHTML = createCardHtml + `<p id="no-projects-message" class="col-span-full text-center text-gray-500 text-lg mt-10">You haven't saved any projects yet. Click above to start!</p>`;
            lucide.createIcons();
            return;
        }

        // Generate HTML for each saved project
        projects.forEach(project => {
            
            // **FIX: Clean the prompt by replacing the literal '\n' sequences with real line breaks**
            const cleanPrompt = project.prompt.replace(/\\n/g, '\n');
            
            // **FIX: Generate a clean title and summary from the cleaned prompt**
            const firstLine = cleanPrompt.split('\n').find(line => line.trim().length > 0) || "Untitled Project";
            const title = firstLine.substring(0, 30).trim() + (firstLine.length > 30 ? '...' : '');
            
            // *** Get the date correctly from the Firestore Timestamp object ***
            let dateObj;
            if (project.createdAt && typeof project.createdAt.toDate === 'function') {
                dateObj = project.createdAt.toDate();
            } else if (project.createdAt && project.createdAt.seconds) {
                dateObj = new Date(project.createdAt.seconds * 1000);
            } else {
                dateObj = new Date();
            }
            const timestamp = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            // **FIXED/UPDATED**: Use Base64 encoding for the HTML content to safely embed in the onclick attribute
            const encodedHtmlContent = btoa(project.htmlContent);
            // Keep JSON.stringify for the title, as it's a simple string that needs quote protection.
            const safeTitle = JSON.stringify(title); 

            // *** Escape the HTML content for display in the snippet box ***
            const escapedCodeSnippet = escapeHtml(project.htmlContent);

            projectsHtml += `
                <div class="bg-white border border-gray-200 rounded-2xl p-6 flex flex-col justify-between shadow-lg hover:shadow-xl transition duration-300">
                    <div>
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-xl font-bold text-gray-900 truncate">${title}</h3>
                            <i data-lucide="layout" class="w-6 h-6 text-ammoue/70 flex-shrink-0"></i>
                        </div>
                        <p class="text-xs text-gray-500 mb-2 h-10 line-clamp-2">${cleanPrompt}</p>
                    </div>

                    <div class="bg-gray-100 border border-gray-300 rounded-lg p-2 mb-4 h-32 overflow-y-scroll text-sm">
                        <pre class="whitespace-pre-wrap">
                            <code class="text-xs text-gray-700">${escapedCodeSnippet}</code>
                        </pre>
                    </div>

                    <div class="mt-auto">
                        <p class="text-xs text-gray-400 mb-3">Saved: ${timestamp}</p>
                        <div class="flex space-x-2">
                            <button onclick="handlePreview('${encodedHtmlContent}')" class="flex-1 px-3 py-2 text-sm font-semibold rounded-xl text-white bg-blue-600 hover:bg-blue-700 transition duration-150 shadow-md">
                                <i data-lucide="eye" class="w-4 h-4 inline-block mr-1"></i> Preview
                            </button>
                            <button onclick="handleDownload('${encodedHtmlContent}', ${safeTitle})" class="px-3 py-2 text-sm font-semibold rounded-xl text-white bg-green-600 hover:bg-green-700 transition duration-150 shadow-md">
                                <i data-lucide="download" class="w-4 h-4 inline-block"></i>
                            </button>
                            <button onclick="handleDeleteProject('${project.id}')" class="px-3 py-2 text-sm font-semibold rounded-xl text-white bg-red-500 hover:bg-red-600 transition duration-150 shadow-md">
                                <i data-lucide="trash-2" class="w-4 h-4 inline-block"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });

        projectsContainer.innerHTML = projectsHtml;
        // Re-render Lucide icons after injecting new HTML
        lucide.createIcons();
    }


    /** Fetches projects for the current user in real-time. */
    function getProjects(userId) {
        if (!db || !userId) return;

        // Collection path: /artifacts/{appId}/users/{userId}/projects
        const projectsRef = collection(db, 'artifacts', appId, 'users', userId, 'projects');
        const q = query(projectsRef);

        // Set up the real-time listener (onSnapshot)
        onSnapshot(q, (snapshot) => {
            const projects = [];
            snapshot.forEach((doc) => {
                const data = doc.data();
                projects.push({
                    id: doc.id,
                    ...data,
                    // Use more sensible default fields for robust rendering
                    title: data.title || data.prompt?.split('\n')[0].substring(0, 30).trim() || "Untitled Project",
                    prompt: data.prompt || "No prompt available",
                    htmlContent: data.htmlContent || "",
                    createdAt: data.createdAt // Keep the Firestore Timestamp object
                });
            });

            // Sort by createdAt descending (newest first) in memory.
            projects.sort((a, b) => {
                const timeA = a.createdAt instanceof Timestamp ? a.createdAt.toMillis() : 0;
                const timeB = b.createdAt instanceof Timestamp ? b.createdAt.toMillis() : 0;
                return timeB - timeA; // Descending order (newest first)
            });

            renderProjects(projects);
        }, (error) => {
            console.error("Error fetching projects:", error);
            showMessage("Failed to load projects.", true);
        });
    }


    /** Initializes Firebase services and sets up the critical auth listener. */
    function initializeAppAndAuth() {
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // CRITICAL: Authentication Gate using the listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // **SUCCESS** - User is authenticated
                    currentUserId = user.uid;
                    isAuthReady = true;

                    // Display user ID or email
                    userEmailSpan.textContent = user.email || user.uid;

                    // Fetch projects for the logged-in user (CORE INTEGRATION)
                    getProjects(currentUserId);

                    // Show dashboard content
                    loadingScreen.classList.add('hidden');
                    dashboardContent.classList.remove('hidden');
                    dashboardContent.classList.add('opacity-100');
                } else {
                    // **FAILURE** - User is NOT authenticated: Redirect to login page
                    console.log("No valid session found. Redirecting to login.html...");
                    window.location.href = 'login.html';
                }
            });

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            showMessage("Initialization error. Redirecting to login...", true);
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 500);
        }
    }

    /** Logs the current user out. */
    window.handleLogout = async function() {
        if (auth) {
            try {
                await signOut(auth);
                showMessage("You have been signed out.", false);
                // Redirect handles itself via onAuthStateChanged listener
            } catch (error) {
                console.error("Logout failed:", error);
                showMessage("Logout failed. Please try again.", true);
            }
        } else {
            window.location.href = 'login.html';
        }
    }

    // --- Run Initialization Immediately ---
    initializeAppAndAuth();
    lucide.createIcons();

</script>
</body>
</html>
