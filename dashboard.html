<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ammoue | Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom Font Setup */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Light gray background */
        }
        .text-ammoue {
            color: #0d9488; /* Teal-700 for Ammoue branding */
        }
        .bg-ammoue {
            background-color: #0d9488; /* Teal-700 for Ammoue branding */
        }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

    <!-- Navbar -->
    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex justify-between items-center">
            <!-- Logo -->
            <a href="#" class="flex items-center space-x-2">
                <span class="text-2xl font-extrabold text-ammoue">Ammoue</span>
                <span class="text-sm font-medium text-gray-500">Dashboard</span>
            </a>
            
            <!-- User/Action Menu -->
            <div class="flex items-center space-x-4">
                <div class="w-8 h-8 bg-teal-200 rounded-full flex items-center justify-center text-sm font-semibold text-ammoue" id="user-initials">...</div>
                <button onclick="handleLogout()" class="text-sm text-gray-500 hover:text-red-500 transition group flex items-center">
                    <i data-lucide="log-out" class="w-5 h-5 mr-1 group-hover:text-red-500"></i>
                    <span class="hidden sm:inline">Logout</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
            
            <!-- New Site Created Notification -->
            <div id="new-site-notification" class="hidden fixed top-4 right-4 bg-green-500 text-white p-4 rounded-xl shadow-2xl transition-opacity duration-500 opacity-100 z-50 transform flex items-center space-x-2">
                <i data-lucide="check-circle" class="w-5 h-5"></i>
                <span>Success! Your new website is created.</span>
            </div>

            <!-- Welcome Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900">Hello, Creator!</h1>
                <p class="text-gray-500 mt-1">Manage your AI-generated websites and start new projects.</p>
            </div>

            <!-- New Project CTA Card (Links to ai_prompt.html) -->
            <div class="bg-white p-6 md:p-10 rounded-2xl shadow-xl border-t-4 border-ammoue mb-12 flex flex-col md:flex-row items-center justify-between">
                <div class="md:w-3/4 mb-4 md:mb-0">
                    <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                        <i data-lucide="sparkles" class="w-6 h-6 mr-3 text-ammoue"></i>
                        Generate a New Site Instantly
                    </h2>
                    <p class="text-gray-600 mt-2">Describe your idea, and our AI will build a complete, ready-to-edit site in under a minute.</p>
                </div>
                <a href="ai_prompt.html" class="w-full md:w-auto px-8 py-3 text-lg font-bold rounded-xl text-white bg-ammoue hover:bg-teal-700 transition duration-300 shadow-lg transform hover:scale-105 text-center">
                    Start with AI Prompt
                </a>
            </div>

            <!-- Projects List Section Header -->
            <h3 class="text-2xl font-bold text-gray-900 mb-6" id="project-count">Your Projects (Loading...)</h3>

            <!-- Loading Spinner -->
            <div id="loading-spinner" class="flex justify-center items-center h-32">
                <svg class="animate-spin h-8 w-8 text-ammoue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>

            <!-- Projects Grid Container (Dynamic Content) -->
            <div id="projects-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Projects will be dynamically injected here -->
            </div>

        </div>
    </main>

    <!-- Footer (Simple) -->
    <footer class="p-4 bg-white border-t border-gray-100 text-center mt-8">
        <p class="text-sm text-gray-500">&copy; 2025 Ammoue. AI-Powered Web Development.</p>
    </footer>

    <!-- Firebase and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- MANDATORY GLOBAL VARIABLES ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth, userId = null;
        let app;

        // --- DOM Elements ---
        const projectsContainer = document.getElementById('projects-container');
        const userInitialsEl = document.getElementById('user-initials');
        const loadingSpinner = document.getElementById('loading-spinner');
        const projectCountEl = document.getElementById('project-count');
        const newSiteNotification = document.getElementById('new-site-notification');

        // --- CORE APPLICATION LOGIC ---

        /**
         * Initializes Firebase and handles user authentication.
         */
        async function initializeAppAndAuth() {
            try {
                // setLogLevel('debug'); // Uncomment for debugging
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Sign in using the provided custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Set up Auth State Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        
                        // Set user initials in UI
                        // Use first letter of email if available, otherwise 'U' for User or 'A' for Anonymous
                        const firstInitial = user.email ? user.email.charAt(0).toUpperCase() : (user.isAnonymous ? 'A' : 'U');
                        userInitialsEl.textContent = firstInitial;
                        
                        getWebsites(); // Start fetching data now that we have the userId
                    } else {
                        // In a real app, this would typically redirect to login.html
                        console.warn("User not authenticated.");
                        loadingSpinner.style.display = 'none';
                        projectsContainer.innerHTML = '<p class="text-center text-red-500 p-8">Could not authenticate. Please check your network or try again later.</p>';
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                loadingSpinner.style.display = 'none';
                projectsContainer.innerHTML = `<p class="text-center text-red-500 p-8">Error initializing the app: ${error.message}</p>`;
            }
        }

        /**
         * Listens to the user's project collection in Firestore for real-time updates.
         */
        function getWebsites() {
            if (!db || !userId) return;

            // Collection path: /artifacts/{appId}/users/{userId}/websites
            const collectionPath = `artifacts/${appId}/users/${userId}/websites`;
            const q = collection(db, collectionPath);
            
            // Listen for real-time changes
            onSnapshot(q, (snapshot) => {
                const websites = [];
                snapshot.forEach((doc) => {
                    websites.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by creation time descending (most recent first)
                websites.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

                renderWebsites(websites);
                loadingSpinner.style.display = 'none';

            }, (error) => {
                console.error("Error fetching websites:", error);
                loadingSpinner.style.display = 'none';
                projectsContainer.innerHTML = `<p class="text-center text-red-500">Error loading projects: ${error.message}</p>`;
            });
        }

        /**
         * Renders the list of websites onto the dashboard.
         * @param {Array} websites - Array of website objects from Firestore.
         */
        function renderWebsites(websites) {
            const totalProjects = websites.length;
            projectCountEl.textContent = `Your Projects (${totalProjects})`;
            projectsContainer.innerHTML = ''; // Clear existing projects

            if (totalProjects === 0) {
                projectsContainer.innerHTML = `
                    <div class="col-span-full text-center text-gray-500 p-12 border border-dashed border-gray-300 rounded-xl">
                        <i data-lucide="folder-open" class="w-8 h-8 mx-auto mb-4 text-gray-400"></i>
                        <p>No projects found. Use the 'Start with AI Prompt' button to create your first site!</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            websites.forEach(website => {
                const status = website.status || 'Draft';
                const title = website.title || 'Untitled Project';
                const promptExcerpt = website.prompt ? website.prompt.substring(0, 75) + (website.prompt.length > 75 ? '...' : '') : 'No description available.';
                
                const statusClass = status === 'Published' 
                    ? 'text-green-700 bg-green-100' 
                    : 'text-yellow-700 bg-yellow-100';
                
                const lastEdited = website.createdAt 
                    ? new Date(website.createdAt).toLocaleDateString()
                    : 'N/A';

                const cardHtml = `
                    <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition duration-300 overflow-hidden border border-gray-100">
                        <div class="h-32 bg-teal-50 flex items-center justify-center text-gray-600 text-sm">
                            <i data-lucide="monitor" class="w-8 h-8 mr-2 text-ammoue"></i>
                            <span class="font-medium truncate">${title}</span>
                        </div>
                        <div class="p-5">
                            <h4 class="font-bold text-lg text-gray-900 truncate">${title}</h4>
                            <p class="text-sm text-gray-500 mt-1 mb-3 h-10 overflow-hidden">${promptExcerpt}</p>
                            <div class="flex justify-between items-center pt-2 border-t border-gray-100">
                                <span class="text-xs font-semibold ${statusClass} px-2 py-1 rounded-full">${status}</span>
                                <a href="#" class="text-ammoue hover:text-teal-600 text-sm font-medium">
                                    Edit Site <i data-lucide="arrow-right" class="w-4 h-4 inline-block ml-1"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                projectsContainer.innerHTML += cardHtml;
            });
            lucide.createIcons(); // Re-create icons for new dynamic content
        }

        /**
         * Logs the user out and redirects to the login page.
         */
        window.handleLogout = async function() {
            try {
                await signOut(auth);
                window.location.href = 'login.html';
            } catch (error) {
                console.error("Logout failed:", error);
            }
        };

        // --- Initialization and Load Handlers ---
        window.onload = function() {
            initializeAppAndAuth();
            
            // Handle success status from ai_prompt.html redirect
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('status') === 'new_site') {
                newSiteNotification.classList.remove('hidden');
                // Auto-fade notification after 3 seconds
                setTimeout(() => {
                    newSiteNotification.classList.add('opacity-0');
                    // Completely hide after fade-out transition
                    setTimeout(() => newSiteNotification.classList.add('hidden'), 500);
                }, 3000);
            }
            
            // Initialize icons for static elements
            lucide.createIcons();
        };
    </script>
</body>
</html>
