<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <link rel="icon" type="image/png" href="Gemini_Generated_Image_qry9pfqry9pfqry9.png">
Â  Â  <title>Ammoue | Code Editor</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <script src="https://unpkg.com/lucide@latest"></script>
Â  Â  <style>
Â  Â  Â  Â  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  Â  Â  background-color: #f1f5f9; /* Slate 100 */
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  }
Â  Â  Â  Â  .text-ammoue { color: #0d9488; }
Â  Â  Â  Â  .bg-ammoue { background-color: #0d9488; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #code-editor {
Â  Â  Â  Â  Â  Â  font-family: monospace;
Â  Â  Â  Â  Â  Â  min-height: 50vh; /* Ensure code editor is large */
Â  Â  Â  Â  Â  Â  resize: vertical;
Â  Â  Â  Â  }

Â  Â  Â  Â  .loading-screen {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 0; left: 0; right: 0; bottom: 0;
Â  Â  Â  Â  Â  Â  background-color: #f8fafc;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  z-index: 50;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body class="antialiased">

Â  Â  <div id="loading-screen" class="loading-screen">
Â  Â  Â  Â  <svg class="animate-spin h-8 w-8 text-ammoue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
Â  Â  Â  Â  Â  Â  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
Â  Â  Â  Â  Â  Â  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
Â  Â  Â  Â  </svg>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="message-box" class="p-4 rounded-xl shadow-2xl text-white font-semibold fixed top-4 left-1/2 transform -translate-x-1/2 opacity-0 transition-opacity duration-300 z-50"></div>

Â  Â  <div id="editor-content" class="flex-grow flex flex-col p-4 md:p-8 max-w-7xl mx-auto w-full hidden">
Â  Â  Â  Â  <div class="bg-white rounded-xl shadow-xl p-6 flex-grow flex flex-col">
Â  Â  Â  Â  Â  Â  <header class="mb-6 border-b pb-4 flex justify-between items-center">
Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-3xl font-bold text-gray-800 flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="code" class="w-8 h-8 text-ammoue mr-3"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Editing: <span id="project-title-header" class="ml-2 text-ammoue truncate max-w-xs md:max-w-md">Loading...</span>
Â  Â  Â  Â  Â  Â  Â  Â  </h1>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.location.href='dashboard.html'" class="px-4 py-2 text-sm font-semibold rounded-xl text-gray-700 bg-gray-200 hover:bg-gray-300 transition duration-150 shadow-md flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i> Back to Dashboard
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </header>

Â  Â  Â  Â  Â  Â  <form id="editor-form" class="flex-grow flex flex-col space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="project-id-input">
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="md:col-span-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="editor-title" class="block text-sm font-medium text-gray-700 mb-1">Project Title</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="editor-title" requiredÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="w-full border border-gray-300 rounded-xl shadow-inner bg-gray-50 focus:border-ammoue focus:ring-2 focus:ring-teal-200 transition duration-150 p-3 text-base text-gray-800">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="md:col-span-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="editor-prompt" class="block text-sm font-medium text-gray-700 mb-1">AI Prompt/Refinement Description</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="editor-prompt" requiredÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="w-full border border-gray-300 rounded-xl shadow-inner bg-gray-50 focus:border-ammoue focus:ring-2 focus:ring-teal-200 transition duration-150 p-3 text-base text-gray-800"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  placeholder="Enter refinement request here (e.g., Change the button color to red, Add a logo, etc.)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-grow flex flex-col min-h-[50vh]">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="code-editor" class="block text-sm font-medium text-gray-700 mb-2">HTML Code Content</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="code-editor" requiredÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â class="flex-grow w-full border border-gray-300 rounded-xl shadow-inner focus:border-ammoue focus:ring-2 focus:ring-teal-200 transition duration-150 p-4 bg-gray-50 text-gray-900 font-mono text-sm"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-end pt-4 border-t space-x-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="preview-btn" class="px-6 py-3 text-lg font-bold rounded-xl text-white bg-gray-500 hover:bg-gray-600 transition duration-150 shadow-lg flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="monitor" class="w-5 h-5 mr-2"></i> Preview Site
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="ai-code-refine-button" class="px-6 py-3 text-lg font-bold rounded-xl text-white bg-red-500 hover:bg-red-600 transition duration-150 shadow-lg flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="zap" class="w-5 h-5 mr-2"></i> AI Refine Code
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" id="save-btn" class="px-6 py-3 text-lg font-bold rounded-xl text-white bg-ammoue hover:bg-teal-700 transition duration-150 shadow-lg flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="save" class="w-5 h-5 mr-2"></i> Save All Changes
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script type="module">
Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
Â  Â  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
Â  Â  import { getFirestore, doc, getDoc, updateDoc, Timestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

Â  Â  // IMPORTANT: Hardcoded configuration from login.html for this specific app instance
Â  Â  const firebaseConfig = {
Â  Â  Â  Â  apiKey: "AIzaSyAmnZ69YDcEFcmuXIhmGxDUSPULxpI-Bmg",
Â  Â  Â  Â  authDomain: "ammoueai.firebaseapp.com",
Â  Â  Â  Â  projectId: "ammoueai",
Â  Â  Â  Â  storageBucket: "ammoueai.firebasestorage.app",
Â  Â  Â  Â  messagingSenderId: "135818868149",
Â  Â  Â  Â  appId: "1:135818868149:web:db9280baf9540a3339d5fc",
Â  Â  };

Â  Â  let auth = null;
Â  Â  let db = null;
Â  Â  let currentUserId = null;
Â  Â  const appId = firebaseConfig.projectId;

Â  Â  // --- DOM Elements ---
Â  Â  const loadingScreen = document.getElementById('loading-screen');
Â  Â  const editorContent = document.getElementById('editor-content');
Â  Â  const msgBox = document.getElementById('message-box');
Â  Â  const editorForm = document.getElementById('editor-form');
Â  Â  const codeEditor = document.getElementById('code-editor');
Â  Â  const titleInput = document.getElementById('editor-title');
Â  Â  const promptInput = document.getElementById('editor-prompt');
Â  Â  const titleHeader = document.getElementById('project-title-header');
Â  Â  const projectIdInput = document.getElementById('project-id-input');
Â  Â  const codeRefineButton = document.getElementById('ai-code-refine-button');
Â  Â  const previewBtn = document.getElementById('preview-btn');
Â  Â  const saveBtn = document.getElementById('save-btn');

Â  Â  let latestDeploymentUrl = ''; // Stores the current deployment URL

Â  Â  // --- Utility Functions ---

Â  Â  /** Shows a temporary message box (replaces alert()) */
Â  Â  function showMessage(message, isError) {
Â  Â  Â  Â  if (!msgBox) return;
Â  Â  Â  Â  msgBox.textContent = message;

Â  Â  Â  Â  msgBox.className = 'p-4 rounded-xl shadow-2xl text-white font-semibold fixed top-4 left-1/2 transform -translate-x-1/2 transition-opacity duration-300 z-50';
Â  Â  Â  Â  msgBox.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
Â  Â  Â  Â  msgBox.classList.add('opacity-100');
Â  Â  Â  Â  setTimeout(() => { msgBox.classList.remove('opacity-100'); }, 4000);
Â  Â  }

Â  Â  /**
Â  Â  Â * Triggers the Vercel Serverless Function to generate and save a project screenshot.
Â  Â  Â * The function uses exponential backoff to handle transient network errors.
Â  Â  Â * @param {string} projectId The ID of the project document in Firestore.
Â  Â  Â * @param {string} userId The UID of the authenticated user.
Â  Â  Â * @param {string} [apiUrl="/api/screenshot"] The path to the Vercel Serverless Function.
Â  Â  Â * @param {number} [maxRetries=5] The maximum number of retry attempts.
Â  Â  Â */
Â  Â  async function triggerScreenshotGeneration(projectId, userId, apiUrl = "/api/screenshot", maxRetries = 5) {
Â  Â  Â  Â  if (!projectId || !userId) {
Â  Â  Â  Â  Â  Â  console.error("Screenshot trigger failed: Missing projectId or userId.");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const payload = { projectId, userId, appId: 'ammoueai' }; 

Â  Â  Â  Â  for (let attempt = 0; attempt < maxRetries; attempt++) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Attempt ${attempt + 1}: Triggering screenshot generation for ${projectId}...`);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Add an initial 5-second wait to give the deployment time to propagate.
Â  Â  Â  Â  Â  Â  Â  Â  if (attempt === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Waiting 5 seconds for deployment propagation before taking screenshot...");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, 5000));
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(apiUrl, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload),
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Screenshot generation successfully triggered/completed:", result.url);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return result; 
Â  Â  Â  Â  Â  Â  Â  Â  } 
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const errorBody = await response.json().catch(() => ({ message: response.statusText }));
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`API failed with status ${response.status}: ${errorBody.message || JSON.stringify(errorBody)}`);

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`Attempt ${attempt + 1} failed for ${projectId}.`, error);

Â  Â  Â  Â  Â  Â  Â  Â  if (attempt === maxRetries - 1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error(`Final screenshot attempt failed for ${projectId}. Check Vercel logs.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return null; 
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Exponential backoff delay
Â  Â  Â  Â  Â  Â  Â  Â  const delay = Math.pow(2, attempt) * 1000;
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Retrying in ${delay / 1000} seconds...`);
Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, delay));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  /**
Â  Â  Â * Helper to set Preview Button state (deployed vs. not).
Â  Â  Â * @param {string} url - The deployment URL.
Â  Â  Â * @param {boolean} isDeploying - Whether a deployment is currently in progress.
Â  Â  Â */
Â  Â  function setPreviewButton(url, isDeploying = false) {
Â  Â  Â  Â  if (!previewBtn) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Disable if no URL or if currently deploying
Â  Â  Â  Â  previewBtn.disabled = !url && !isDeploying;Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  previewBtn.classList.remove('bg-green-600', 'bg-blue-600', 'bg-yellow-600', 'bg-red-500', 'bg-gray-500');
Â  Â  Â  Â  previewBtn.classList.remove('disabled:opacity-50'); // Remove default disabled style

Â  Â  Â  Â  if (isDeploying) {
Â  Â  Â  Â  Â  Â  previewBtn.textContent = 'Deployment in Progress...';
Â  Â  Â  Â  Â  Â  previewBtn.classList.add('bg-yellow-600');
Â  Â  Â  Â  Â  Â  saveBtn.disabled = true;
Â  Â  Â  Â  Â  Â  codeRefineButton.disabled = true;
Â  Â  Â  Â  } else if (url) {
Â  Â  Â  Â  Â  Â  previewBtn.textContent = 'Preview Site (Deployed)';
Â  Â  Â  Â  Â  Â  previewBtn.classList.add('bg-green-600');
Â  Â  Â  Â  Â  Â  saveBtn.disabled = false;
Â  Â  Â  Â  Â  Â  codeRefineButton.disabled = false;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  previewBtn.textContent = 'Preview Site (Not Deployed)';
Â  Â  Â  Â  Â  Â  previewBtn.classList.add('bg-gray-500');
Â  Â  Â  Â  Â  Â  saveBtn.disabled = false;
Â  Â  Â  Â  Â  Â  codeRefineButton.disabled = false;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  /**
Â  Â  Â * Fetches the user's current plan (free, pro, etc.).
Â  Â  Â * @param {string} userId - The current user's ID.
Â  Â  Â * @returns {Promise<string>} The user's plan name (e.g., 'free').
Â  Â  Â */
Â  Â  async function getUserPlan(userId) {
Â  Â  Â  Â  if (!db || !userId) return 'free';Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // Path: /users/{userId}
Â  Â  Â  Â  Â  Â  const docRef = doc(db, 'users', userId);
Â  Â  Â  Â  Â  Â  const docSnap = await getDoc(docRef);
Â  Â  Â  Â  Â  Â  return docSnap.exists() && docSnap.data().plan ? docSnap.data().plan : 'free';
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Error fetching user plan:", error);
Â  Â  Â  Â  Â  Â  return 'free';Â 
Â  Â  Â  Â  }
Â  Â  }

Â  Â  /** * Handles the actual deployment process by calling the server API.
Â  Â  Â * @param {string} htmlContent - The HTML content to deploy.
Â  Â  Â * @param {string} plan - The user's current plan (required by server).
Â  Â  Â * @param {string} projectId - The ID of the project being deployed (required by server).
Â  Â  Â * @returns {Promise<string|null>} The new deployment URL on success, or null on failure.
Â  Â  Â */
Â  Â  async function handleDeployment(htmlContent, plan, projectId) {
Â  Â  Â  Â  if (!currentUserId) {
Â  Â  Â  Â  Â  Â  showMessage("Authentication error: User ID is missing.", true);
Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  }
Â  Â  Â  Â  if (!plan || !projectId) {
Â  Â  Â  Â  Â  Â  showMessage("System error: Missing Plan or Project ID for deployment.", true);
Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  }

Â  Â  Â  Â  const initialUrl = latestDeploymentUrl;
Â  Â  Â  Â  setPreviewButton(initialUrl, true); // Set the button to a 'deploying' state

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch("/api/deploy", {
Â  Â  Â  Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  htmlContent: htmlContent,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userId: currentUserId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  plan: plan,Â  Â  Â  Â  Â // âœ… FIX: Added plan
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  projectId: projectId // âœ… FIX: Added projectId
Â  Â  Â  Â  Â  Â  Â  Â  }),
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const result = await response.json();

Â  Â  Â  Â  Â  Â  if (response.ok && result.deploymentUrl) {
Â  Â  Â  Â  Â  Â  Â  Â  const newUrl = result.deploymentUrl;

Â  Â  Â  Â  Â  Â  Â  Â  showMessage("âœ… Deployment initiated. Waiting 30 seconds for propagation...", false);

Â  Â  Â  Â  Â  Â  Â  Â  // --- START OF DELAY LOGIC ---
Â  Â  Â  Â  Â  Â  Â  Â  const delayInSeconds = 30; // Use 30 seconds delay
Â  Â  Â  Â  Â  Â  Â  Â  let countdown = delayInSeconds;
Â  Â  Â  Â  Â  Â  Â  Â  const interval = setInterval(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  countdown--;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previewBtn.textContent = `Preview Site (Wait ${countdown}s)`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (countdown <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(interval);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setPreviewButton(newUrl, false);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Deployment is complete. You can preview the site!", false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }, 1000);
Â  Â  Â  Â  Â  Â  Â  Â  // --- END OF DELAY LOGIC ---

Â  Â  Â  Â  Â  Â  Â  Â  return newUrl; // Return the new URL
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Vercel Deployment Failed:", result);
Â  Â  Â  Â  Â  Â  Â  Â  // The server now returns a useful error like "FREE plan limit reached..."
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(result.details || result.error || "Deployment failed on Vercel.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Deployment Error:", error);
Â  Â  Â  Â  Â  Â  setPreviewButton(initialUrl, false); // Revert or reset button state
Â  Â  Â  Â  Â  Â  showMessage(`âŒ Deployment failed: ${error.message}`, true);
Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // New: Handles Preview Button Click
Â  Â  function handlePreview() {
Â  Â  Â  Â  if (!latestDeploymentUrl) {
Â  Â  Â  Â  Â  Â  showMessage("Site not deployed yet.", true);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  window.open(latestDeploymentUrl, "_blank");
Â  Â  }

Â  Â  /** Extracts project ID from the URL query parameters. */
Â  Â  function getProjectIdFromUrl() {
Â  Â  Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  Â  Â  return urlParams.get('id');
Â  Â  }

Â  Â  /** Fetches the project document from Firestore. */
Â  Â  async function fetchProjectData(projectId, userId) {
Â  Â  Â  Â  if (!db || !userId) {
Â  Â  Â  Â  Â  Â  showMessage("Database not initialized.", true);
Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // Document path: /artifacts/{appId}/users/{userId}/projects/{projectId}
Â  Â  Â  Â  Â  Â  const docRef = doc(db, 'artifacts', appId, 'users', userId, 'projects', projectId);
Â  Â  Â  Â  Â  Â  const docSnap = await getDoc(docRef);

Â  Â  Â  Â  Â  Â  if (docSnap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  const data = docSnap.data();
Â  Â  Â  Â  Â  Â  Â  Â  // Clean the prompt by replacing the literal '\n' sequences with real line breaks
Â  Â  Â  Â  Â  Â  Â  Â  const cleanPrompt = data.prompt ? data.prompt.replace(/\\n/g, '\n') : "No prompt available";
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // FIX: Clean incoming HTML content from the database (removes ```html fences)
Â  Â  Â  Â  Â  Â  Â  Â  let cleanHtmlContent = data.htmlContent || '';
Â  Â  Â  Â  Â  Â  Â  Â  cleanHtmlContent = cleanHtmlContent
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .replace(/^```(html)?\s*\n?/i, "") // Remove starting fences and optional newline
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .replace(/\n?```$/i, "")Â  Â  Â  Â  Â  Â  // Remove trailing fences and optional newline
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .trim();

Â  Â  Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: docSnap.id,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...data,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  prompt: cleanPrompt,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  htmlContent: cleanHtmlContent, // Use the cleaned HTML
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  deploymentUrl: data.deploymentUrl || '', // Ensure URL is captured
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Error: Project not found.", true);
Â  Â  Â  Â  Â  Â  Â  Â  console.error("No such document!");
Â  Â  Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Error fetching document:", error);
Â  Â  Â  Â  Â  Â  showMessage("Failed to load project details.", true);
Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  /** Handles form submission to update Firestore with new code and trigger re-deployment. */
Â  Â  async function handleSave(e) {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!currentUserId) {
Â  Â  Â  Â  Â  Â  showMessage("User not authenticated.", true);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const projectId = projectIdInput.value;
Â  Â  Â  Â  const newTitle = titleInput.value.trim();
Â  Â  Â  Â  const newPrompt = promptInput.value.trim();
Â  Â  Â  Â  const newHtmlContent = codeEditor.value;

Â  Â  Â  Â  if (!newTitle || !newPrompt || !newHtmlContent || !projectId) {
Â  Â  Â  Â  Â  Â  showMessage("Title, Prompt, Code, and Project ID cannot be empty.", true);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  showMessage("Saving changes and re-deploying site...", false);

Â  Â  Â  Â  // ðŸš¨ CRITICAL FIX: Fetch plan before deployment
Â  Â  Â  Â  const userPlan = await getUserPlan(currentUserId);

Â  Â  Â  Â  // 1. Trigger deployment first to get the URL
Â  Â  Â  Â  const updatedDeploymentUrl = await handleDeployment(newHtmlContent, userPlan, projectId);
Â  Â  Â  Â  latestDeploymentUrl = updatedDeploymentUrl || latestDeploymentUrl; // Update global URL, keep old one if failed

Â  Â  Â  Â  // 2. Update Firestore
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // Document path: /artifacts/{appId}/users/{userId}/projects/{projectId}
Â  Â  Â  Â  Â  Â  const docRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'projects', projectId);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  await updateDoc(docRef, {
Â  Â  Â  Â  Â  Â  Â  Â  title: newTitle,Â 
Â  Â  Â  Â  Â  Â  Â  Â  prompt: newPrompt.replace(/\n/g, '\\n'), // Escape newlines for consistency
Â  Â  Â  Â  Â  Â  Â  Â  htmlContent: newHtmlContent,
Â  Â  Â  Â  Â  Â  Â  Â  deploymentUrl: latestDeploymentUrl, // Save the new/old URL
Â  Â  Â  Â  Â  Â  Â  Â  updatedAt: Timestamp.fromDate(new Date()) // Update the timestamp
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // Update the header instantly
Â  Â  Â  Â  Â  Â  titleHeader.textContent = newTitle;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  showMessage(`Project "${newTitle}" saved, and deployment initiated!`, false);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // 3. CRITICAL: Trigger Vercel Screenshot in the background
Â  Â  Â  Â  Â  Â  // This runs asynchronously and does not block the UI or the save confirmation
Â  Â  Â  Â  Â  Â  triggerScreenshotGeneration(projectId, currentUserId)
Â  Â  Â  Â  Â  Â  Â  Â  .then(() => console.log("Background screenshot job finished."))
Â  Â  Â  Â  Â  Â  Â  Â  .catch(err => console.error("Screenshot job failed:", err));
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Error updating document:", error);
Â  Â  Â  Â  Â  Â  showMessage("Failed to save changes. Check console for details.", true);
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // --- Handles the AI Code Refinement request ---
Â  Â  async function handleCodeRefine() {
Â  Â  Â  Â  const currentHtml = codeEditor.value;
Â  Â  Â  Â  const refinePrompt = promptInput.value.trim(); // Use the existing prompt field for the request
Â  Â  Â  Â  const projectId = projectIdInput.value;

Â  Â  Â  Â  if (!currentHtml || !refinePrompt || !projectId) {
Â  Â  Â  Â  Â  Â  showMessage("Code, Refinement Description, and Project ID are required for AI refinement and deployment.", true);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Disable button while processing
Â  Â  Â  Â  codeRefineButton.disabled = true;
Â  Â  Â  Â  codeRefineButton.classList.add('opacity-50', 'cursor-not-allowed');
Â  Â  Â  Â  showMessage("Sending code to AI for refinement. Please wait...", false);

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // 1. Send code to AI refine endpoint
Â  Â  Â  Â  Â  Â  const response = await fetch('/api/refine', {Â 
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Pass the user's auth token for securing the API call
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Authorization': `Bearer ${await auth.currentUser.getIdToken()}`
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentHtml: currentHtml,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refinePrompt: refinePromptÂ 
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  const errorText = await response.text();
Â  Â  Â  Â  Â  Â  Â  Â  let errorData = { error: `HTTP error! status: ${response.status}` };
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorData = JSON.parse(errorText);
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Non-JSON error response:", errorText);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorData.error = `Server returned invalid response. Status: ${response.status}`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(errorData.error || errorData.message || `HTTP error! status: ${response.status}`);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  const refinedCode = data.htmlCode;

Â  Â  Â  Â  Â  Â  if (refinedCode) {
Â  Â  Â  Â  Â  Â  Â  Â  // 1. Update the code editor field with the refined HTML
Â  Â  Â  Â  Â  Â  Â  Â  codeEditor.value = refinedCode;
Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Code refined successfully by AI! Starting re-deployment...", false);

Â  Â  Â  Â  Â  Â  Â  Â  // ðŸš¨ CRITICAL FIX: Fetch plan before deployment
Â  Â  Â  Â  Â  Â  Â  Â  const userPlan = await getUserPlan(currentUserId);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 2. Re-deploy the new code
Â  Â  Â  Â  Â  Â  Â  Â  // âœ… FIX: Pass the required plan and projectId to handleDeployment
Â  Â  Â  Â  Â  Â  Â  Â  const updatedDeploymentUrl = await handleDeployment(refinedCode, userPlan, projectId);
Â  Â  Â  Â  Â  Â  Â  Â  latestDeploymentUrl = updatedDeploymentUrl || latestDeploymentUrl;

Â  Â  Â  Â  Â  Â  Â  Â  // 3. Auto-save the changes to Firestore (including new URL)
Â  Â  Â  Â  Â  Â  Â  Â  const docRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'projects', projectId);
Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(docRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  prompt: promptInput.value.replace(/\n/g, '\\n'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  htmlContent: refinedCode,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  deploymentUrl: latestDeploymentUrl,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updatedAt: Timestamp.fromDate(new Date())
Â  Â  Â  Â  Â  Â  Â  Â  });

                // 4. CRITICAL: Trigger Vercel Screenshot in the background for the newly refined code
                triggerScreenshotGeneration(projectId, currentUserId)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(() => console.log("Background screenshot job finished after AI refinement."))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .catch(err => console.error("Screenshot job failed after AI refinement:", err));
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showMessage("Code refined, re-deployed, and saved successfully!", false);

Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage("AI returned empty code. Check the refinement description.", true);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Error refining code:", error);
Â  Â  Â  Â  Â  Â  showMessage(`Code refinement failed: ${error.message}`, true);
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  // Re-enable buttons
Â  Â  Â  Â  Â  Â  codeRefineButton.disabled = false;
Â  Â  Â  Â  Â  Â  codeRefineButton.classList.remove('opacity-50', 'cursor-not-allowed');
Â  Â  Â  Â  }
Â  Â  }
Â  Â  // --- End AI Code Refine Function ---


Â  Â  /** Initializes Firebase and loads the project data. */
Â  Â  function initializeAppAndLoadData() {
Â  Â  Â  Â  const projectId = getProjectIdFromUrl();
Â  Â  Â  Â  if (!projectId) {
Â  Â  Â  Â  Â  Â  showMessage("Error: No project ID provided in URL.", true);
Â  Â  Â  Â  Â  Â  setTimeout(() => { window.location.href = 'dashboard.html'; }, 2000);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  Â  Â  Â  Â  auth = getAuth(app);
Â  Â  Â  Â  Â  Â  db = getFirestore(app);

Â  Â  Â  Â  Â  Â  onAuthStateChanged(auth, async (user) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentUserId = user.uid;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const project = await fetchProjectData(projectId, currentUserId);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (project) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  projectIdInput.value = project.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  titleInput.value = project.title;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  promptInput.value = project.prompt;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  codeEditor.value = project.htmlContent;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  titleHeader.textContent = project.title;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  latestDeploymentUrl = project.deploymentUrl || ''; // Initialize URL
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Set initial preview button state
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setPreviewButton(latestDeploymentUrl, false);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Show content
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadingScreen.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  editorContent.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Project fetch failed or not found, redirect
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â setTimeout(() => { window.location.href = 'dashboard.html'; }, 2000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // No valid session found. Redirect to login.html
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("No valid session found. Redirecting to login.html...");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = 'login.html';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Firebase initialization failed:", error);
Â  Â  Â  Â  Â  Â  showMessage("Initialization error. Redirecting to login...", true);
Â  Â  Â  Â  Â  Â  setTimeout(() => { window.location.href = 'login.html'; }, 500);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // Attach the submit listener and initialize
Â  Â  if (editorForm) {
Â  Â  Â  Â  editorForm.addEventListener('submit', handleSave);
Â  Â  }
Â  Â  // Attach listener to the AI Code Refine button
Â  Â  if (codeRefineButton) {
Â  Â  Â  Â  codeRefineButton.addEventListener('click', handleCodeRefine);
Â  Â  }
Â  Â  // Attach listener to the Preview button
Â  Â  if (previewBtn) {
Â  Â  Â  Â  previewBtn.addEventListener('click', handlePreview);
Â  Â  }

Â  Â  initializeAppAndLoadData();
Â  Â  lucide.createIcons();
Â  Â  </script>
</body>
</html>
