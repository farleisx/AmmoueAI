<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="Gemini_Generated_Image_qry9pfqry9pfqry9.png">
    <title>Preview | Ammoue AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #030303; }
        iframe { width: 100%; height: 100%; border: none; background: white; transition: opacity 0.3s ease; }
        .badge {
            position: fixed; bottom: 20px; right: 20px;
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 16px; border-radius: 99px;
            color: white; font-family: sans-serif; font-size: 12px;
            text-decoration: none; display: flex; align-items: center; gap: 8px;
            transition: all 0.2s; z-index: 9999;
        }
        .badge:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-2px); }
        .loader { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: #030303; z-index: 50; }
        
        #console-toggle {
            position: fixed; bottom: 20px; left: 20px;
            background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 12px; border-radius: 8px;
            color: #fbbf24; font-family: monospace; font-size: 12px;
            cursor: pointer; z-index: 10000; display: flex; align-items: center; gap: 6px;
        }
        #console-panel {
            position: fixed; bottom: 0; left: 0; right: 0; height: 30%;
            background: #111; border-top: 1px solid #333;
            color: #eee; font-family: monospace; font-size: 12px;
            display: none; flex-direction: column; z-index: 9998;
        }
        #console-header {
            padding: 8px 16px; background: #222; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333;
        }
        #console-logs { flex: 1; overflow-y: auto; padding: 10px; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #222; padding-bottom: 2px; white-space: pre-wrap; }
        .log-error { color: #f87171; }
        .log-warn { color: #fbbf24; }

        #tree-toggle {
            position: fixed; top: 20px; left: 20px;
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px; border-radius: 8px;
            color: white; cursor: pointer; z-index: 10000;
        }
        #project-tree {
            position: fixed; top: 0; left: 0; bottom: 0; width: 250px;
            background: #0a0a0a; border-right: 1px solid #222;
            display: none; flex-direction: column; z-index: 9997;
            padding-top: 70px; color: #ccc; font-family: sans-serif; font-size: 13px;
        }
        .tree-item {
            padding: 8px 20px; cursor: pointer; display: flex; align-items: center; gap: 10px;
            transition: background 0.2s;
        }
        .tree-item:hover { background: #1a1a1a; color: white; }
        .tree-item.active { background: #2563eb; color: white; }
        .reload-indicator { margin-left: 10px; color: #4ade80; font-size: 10px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    </style>
</head>
<body>

    <div id="loader" class="loader">
        <div class="w-10 h-10 border-4 border-white/10 border-t-white rounded-full animate-spin"></div>
    </div>

    <iframe id="output-frame" class="opacity-0"></iframe>

    <div id="tree-toggle" onclick="const tree = document.getElementById('project-tree'); tree.style.display = tree.style.display === 'flex' ? 'none' : 'flex'">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9h18M3 15h18M3 6h18M3 18h18"/></svg>
    </div>

    <div id="project-tree">
        <div style="padding: 0 20px 10px 20px; font-weight: bold; border-bottom: 1px solid #222; margin-bottom: 10px; color: white;">Files</div>
        <div id="tree-content"></div>
    </div>

    <div id="console-toggle" onclick="document.getElementById('console-panel').style.display = document.getElementById('console-panel').style.display === 'flex' ? 'none' : 'flex'">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
        Console <span id="reload-notif" class="reload-indicator" style="display:none">‚óè LIVE</span>
    </div>

    <div id="console-panel">
        <div id="console-header">
            <span>System Console</span>
            <button onclick="document.getElementById('console-logs').innerHTML = ''" style="color:#999">Clear</button>
        </div>
        <div id="console-logs"></div>
    </div>

    <a href="/" class="badge">
        <span>Built with <strong>Ammoue AI</strong></span>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14m-7-7 7 7-7 7"/></svg>
    </a>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
        import { firebaseConfig } from "./fire_prompt.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let unsubscribe = null;

        window.addEventListener('message', (event) => {
            if (event.data.type === 'console') {
                const logs = document.getElementById('console-logs');
                const div = document.createElement('div');
                div.className = `log-entry log-${event.data.level}`;
                div.textContent = `[${event.data.level.toUpperCase()}] ${event.data.content}`;
                logs.appendChild(div);
                logs.scrollTop = logs.scrollHeight;
            }
        });

        function renderOutput(data, targetFile, pid, uid) {
            const pages = data.pages || {};
            const frame = document.getElementById('output-frame');
            document.title = `${data.projectName || 'Project'} - ${targetFile}`;

            const treeContent = document.getElementById('tree-content');
            treeContent.innerHTML = '';
            Object.keys(pages).sort().forEach(filename => {
                const item = document.createElement('div');
                item.className = `tree-item ${filename === targetFile ? 'active' : ''}`;
                item.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg> ${filename}`;
                item.onclick = () => { window.location.href = `p.html?id=${pid}&u=${uid}&file=${filename}`; };
                treeContent.appendChild(item);
            });

            let content = pages[targetFile]?.content || (targetFile === 'index.html' ? data.htmlContent : null);

            if (!content && (Object.keys(pages).some(f => f.match(/\.(jsx|tsx|js)$/)))) {
                const entryFile = pages['App.js'] || pages['page.js'] || pages['index.js'] || pages['App.jsx'] || 
                                  Object.entries(pages).find(([name]) => name.match(/\.(js|jsx)$/) && !name.includes('config'))?.[1];
                
                if (entryFile) {
                    content = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <script src="https://unpkg.com/react@18/umd/react.development.js"><\/script>
                            <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"><\/script>
                            <script src="https://unpkg.com/@babel/standalone/babel.min.js"><\/script>
                            <script src="https://cdn.tailwindcss.com"><\/script>
                            <script>
                                window.process = { env: { NODE_ENV: 'development' } };
                                window.exports = {}; window.module = { exports: window.exports };
                                
                                const proxyGen = (n) => new Proxy(() => null, {
                                    get: (t, p) => p === '$$typeof' ? undefined : p === 'displayName' ? n : proxyGen(n + '.' + String(p))
                                });

                                window.motion = window.motion || proxyGen('motion');
                                window.lucide = window.lucide || proxyGen('lucide');
                                window.NextImage = (p) => React.createElement('img', p);
                                window.NextLink = (p) => React.createElement('a', { ...p, onClick: (e) => { e.preventDefault(); console.log('Link to:', p.href); } });

                                window.require = (path) => {
                                    const registry = {
                                        'react': window.React, 'react-dom': window.ReactDOM, 'react-dom/client': window.ReactDOM,
                                        'framer-motion': window.motion, 'lucide-react': window.lucide,
                                        'next/image': window.NextImage, 'next/link': window.NextLink
                                    };
                                    return registry[path] || proxyGen(path);
                                };
                            <\/script>
                        </head>
                        <body>
                            <div id="root"></div>
                            <script type="text/babel" data-type="module">
                                try {
                                    const source = \`${entryFile.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`;
                                    
                                    // PRE-FLIGHT TRANSFORM: Convert ESM to executable script while avoiding identifier clashes
                                    const transformed = source
                                        .replace(/import\\s+.*?from\\s+['"]next\\/link['"];?/g, 'const Link = window.NextLink;')
                                        .replace(/import\\s+.*?from\\s+['"]next\\/image['"];?/g, 'const Image = window.NextImage;')
                                        .replace(/import\\s+(?:\\*\\s+as\\s+)?(\\w+)\\s+from\\s+['"]framer-motion['"];?/g, 'const $1 = window.motion;')
                                        .replace(/import\\s+\\{([^}]+)\\}\\s+from\\s+['"]lucide-react['"];?/g, 'const {$1} = window.lucide;')
                                        .replace(/import\\s+.*?from\\s+['"].*?['"];?/g, '// External Import Ignored')
                                        .replace(/export\\s+default\\s+function\\s+(\\w+)/g, 'function $1')
                                        .replace(/export\\s+default/g, 'const DefaultExport =')
                                        .replace(/export\\s+\\{[^}]+\\};?/g, '');

                                    eval(Babel.transform(transformed, { presets: ['react'] }).code);

                                    class ErrorBoundary extends React.Component {
                                        constructor(props) { super(props); this.state = { err: null }; }
                                        static getDerivedStateFromError(err) { return { err }; }
                                        render() { return this.state.err ? <div style={{color:'red', padding:20}}>Runtime Error: {this.state.err.message}</div> : this.props.children; }
                                    }

                                    const root = ReactDOM.createRoot(document.getElementById('root'));
                                    const Target = typeof App !== 'undefined' ? App : (typeof DefaultExport !== 'undefined' ? DefaultExport : window.exports.default);
                                    if (Target) root.render(<ErrorBoundary><Target /></ErrorBoundary>);
                                } catch (e) { console.error("Babel/Runtime Error: " + e.message); }
                            <\/script>
                        </body>
                        </html>
                    `;
                }
            }

            if (!content) return;

            const bridge = `<script>
                const cap = (l) => (...a) => window.parent.postMessage({type:'console', level:l, content:a.map(x=>typeof x==='object'?JSON.stringify(x):x).join(' ')}, '*');
                console.log=cap('log'); console.error=cap('error'); console.warn=cap('warn');
            <\/script>`;
            content = content.replace('<head>', '<head>' + bridge);

            const docBlob = frame.contentWindow.document;
            docBlob.open(); docBlob.write(content); docBlob.close();
            frame.onload = () => { document.getElementById('loader').classList.add('hidden'); frame.classList.remove('opacity-0'); };
        }

        function initSync() {
            const params = new URLSearchParams(window.location.search);
            const pid = params.get('id'), uid = params.get('u'), file = params.get('file') || 'index.html';
            if (!pid || !uid) return;

            if (unsubscribe) unsubscribe();
            unsubscribe = onSnapshot(doc(db, "artifacts", "ammoueai", "users", uid, "projects", pid), (snap) => {
                if (snap.exists()) {
                    document.getElementById('reload-notif').style.display = 'inline';
                    renderOutput(snap.data(), file, pid, uid);
                    setTimeout(() => { document.getElementById('reload-notif').style.display = 'none'; }, 2000);
                }
            });
        }
        window.addEventListener('load', initSync);
    </script>
</body>
</html>
