<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="Gemini_Generated_Image_qry9pfqry9pfqry9.png">
    <title>Preview | Ammoue AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #030303; }
        iframe { width: 100%; height: 100%; border: none; background: white; transition: opacity 0.3s ease; }
        .badge {
            position: fixed; bottom: 20px; right: 20px;
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 16px; border-radius: 99px;
            color: white; font-family: sans-serif; font-size: 12px;
            text-decoration: none; display: flex; align-items: center; gap: 8px;
            transition: all 0.2s; z-index: 9999;
        }
        .badge:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-2px); }
        .loader { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: #030303; z-index: 50; }
        
        /* Console Styles */
        #console-toggle {
            position: fixed; bottom: 20px; left: 20px;
            background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 12px; border-radius: 8px;
            color: #fbbf24; font-family: monospace; font-size: 12px;
            cursor: pointer; z-index: 10000; display: flex; align-items: center; gap: 6px;
        }
        #console-panel {
            position: fixed; bottom: 0; left: 0; right: 0; height: 30%;
            background: #111; border-top: 1px solid #333;
            color: #eee; font-family: monospace; font-size: 12px;
            display: none; flex-direction: column; z-index: 9998;
        }
        #console-header {
            padding: 8px 16px; background: #222; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333;
        }
        #console-logs { flex: 1; overflow-y: auto; padding: 10px; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #222; padding-bottom: 2px; white-space: pre-wrap; }
        .log-error { color: #f87171; }
        .log-warn { color: #fbbf24; }

        /* Project Tree Styles */
        #tree-toggle {
            position: fixed; top: 20px; left: 20px;
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px; border-radius: 8px;
            color: white; cursor: pointer; z-index: 10000;
        }
        #project-tree {
            position: fixed; top: 0; left: 0; bottom: 0; width: 250px;
            background: #0a0a0a; border-right: 1px solid #222;
            display: none; flex-direction: column; z-index: 9997;
            padding-top: 70px; color: #ccc; font-family: sans-serif; font-size: 13px;
        }
        .tree-item {
            padding: 8px 20px; cursor: pointer; display: flex; align-items: center; gap: 10px;
            transition: background 0.2s;
        }
        .tree-item:hover { background: #1a1a1a; color: white; }
        .tree-item.active { background: #2563eb; color: white; }
    </style>
</head>
<body>

    <div id="loader" class="loader">
        <div class="w-10 h-10 border-4 border-white/10 border-t-white rounded-full animate-spin"></div>
    </div>

    <iframe id="output-frame" class="opacity-0"></iframe>

    <div id="tree-toggle" onclick="const tree = document.getElementById('project-tree'); tree.style.display = tree.style.display === 'flex' ? 'none' : 'flex'">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9h18M3 15h18M3 6h18M3 18h18"/></svg>
    </div>

    <div id="project-tree">
        <div style="padding: 0 20px 10px 20px; font-weight: bold; border-bottom: 1px solid #222; margin-bottom: 10px; color: white;">Files</div>
        <div id="tree-content"></div>
    </div>

    <div id="console-toggle" onclick="document.getElementById('console-panel').style.display = document.getElementById('console-panel').style.display === 'flex' ? 'none' : 'flex'">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
        Console
    </div>

    <div id="console-panel">
        <div id="console-header">
            <span>System Console</span>
            <button onclick="document.getElementById('console-logs').innerHTML = ''" style="color:#999">Clear</button>
        </div>
        <div id="console-logs"></div>
    </div>

    <a href="/" class="badge">
        <span>Built with <strong>Ammoue AI</strong></span>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14m-7-7 7 7-7 7"/></svg>
    </a>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
        import { firebaseConfig } from "./fire_prompt.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global Console Capture for Iframe
        window.addEventListener('message', (event) => {
            if (event.data.type === 'console') {
                const logs = document.getElementById('console-logs');
                const div = document.createElement('div');
                div.className = `log-entry log-${event.data.level}`;
                div.textContent = `[${event.data.level.toUpperCase()}] ${event.data.content}`;
                logs.appendChild(div);
                logs.scrollTop = logs.scrollHeight;
            }
        });

        async function loadSharedProject() {
            const params = new URLSearchParams(window.location.search);
            const pid = params.get('id');
            const uid = params.get('u');
            const targetFile = params.get('file') || 'index.html';

            if (!pid || !uid) {
                document.body.innerHTML = "<div style='color:white; padding:50px;'>Invalid Preview Link.</div>";
                return;
            }

            try {
                const docRef = doc(db, "artifacts", "ammoueai", "users", uid, "projects", pid);
                const snap = await getDoc(docRef);

                if (snap.exists()) {
                    const data = snap.data();
                    const pages = data.pages || {};
                    const frame = document.getElementById('output-frame');
                    
                    document.title = `${data.projectName || 'Project'} - ${targetFile}`;

                    // Populate Project Tree
                    const treeContent = document.getElementById('tree-content');
                    treeContent.innerHTML = '';
                    Object.keys(pages).sort().forEach(filename => {
                        const item = document.createElement('div');
                        item.className = `tree-item ${filename === targetFile ? 'active' : ''}`;
                        item.innerHTML = `
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>
                            ${filename}
                        `;
                        item.onclick = () => {
                            window.location.href = `p.html?id=${pid}&u=${uid}&file=${filename}`;
                        };
                        treeContent.appendChild(item);
                    });

                    let content = pages[targetFile] ? pages[targetFile].content : null;

                    if (!content && targetFile === 'index.html') {
                        content = data.htmlContent;
                    }

                    // React/Next.js Auto-Detection
                    if (!content && (Object.keys(pages).some(f => f.endsWith('.jsx') || f.endsWith('.tsx') || f.endsWith('.js')))) {
                        const entryFile = pages['App.js'] || pages['page.js'] || pages['index.js'] || pages['App.jsx'] || 
                                          Object.entries(pages).find(([name, file]) => 
                                            (name.endsWith('.js') || name.endsWith('.jsx')) && 
                                            !name.includes('config') && 
                                            !name.includes('.json')
                                          )?.[1];
                        
                        if (entryFile) {
                            content = `
                                <!DOCTYPE html>
                                <html>
                                <head>
                                    <script src="https://unpkg.com/react@18/umd/react.development.js"><\/script>
                                    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"><\/script>
                                    <script src="https://unpkg.com/@babel/standalone/babel.min.js"><\/script>
                                    <script src="https://cdn.tailwindcss.com"><\/script>
                                    <script>
                                        // 1. CommonJS Polyfills
                                        window.exports = window.exports || {};
                                        window.module = window.module || { exports: window.exports };
                                        
                                        // 2. Anti-Crash Proxy (Solves "Cannot read properties of undefined reading h1")
                                        const createSafeProxy = (name) => new Proxy(() => null, {
                                            get: (target, prop) => {
                                                if (prop === '$$typeof') return undefined;
                                                // If it's a 'motion' object, return a standard HTML tag string
                                                if (name === 'motion') return prop; 
                                                return createSafeProxy(prop);
                                            }
                                        });

                                        window.motion = window.motion || createSafeProxy('motion');
                                        window.lucide = window.lucide || createSafeProxy('lucide');

                                        window.require = window.require || function(path) {
                                            if (path === 'react') return window.React;
                                            if (path === 'react-dom') return window.ReactDOM;
                                            if (path === 'react-dom/client') return window.ReactDOM;
                                            if (path === 'framer-motion') return window.motion;
                                            if (path === 'lucide-react') return window.lucide;
                                            if (path.includes('next/')) return createSafeProxy(path);
                                            return createSafeProxy(path);
                                        };
                                    <\/script>
                                </head>
                                <body>
                                    <div id="root"></div>
                                    <script type="text/babel">
                                        // Support for Next.js Image/Link placeholders
                                        const Image = (props) => <img {...props} />;
                                        const Link = (props) => <a {...props} />;

                                        ${entryFile.content.replace(/export\s+default/g, 'const DefaultExport =')}
                                        
                                        const rootElement = document.getElementById('root');
                                        if (rootElement) {
                                            const root = ReactDOM.createRoot(rootElement);
                                            const RenderApp = typeof App !== 'undefined' ? App : 
                                                              typeof DefaultExport !== 'undefined' ? DefaultExport : 
                                                              (window.exports && window.exports.default) ? window.exports.default : null;
                                            
                                            if (RenderApp) {
                                                root.render(<RenderApp />);
                                            }
                                        }
                                    <\/script>
                                </body>
                                </html>
                            `;
                        }
                    }

                    if (!content) throw new Error(`File "${targetFile}" not found.`);

                    const consoleBridge = `
                        <script>
                            const originalLog = console.log;
                            const originalError = console.error;
                            const originalWarn = console.warn;
                            
                            console.log = (...args) => {
                                window.parent.postMessage({type: 'console', level: 'log', content: args.join(' ')}, '*');
                                originalLog(...args);
                            };
                            console.error = (...args) => {
                                window.parent.postMessage({type: 'console', level: 'error', content: args.join(' ')}, '*');
                                originalError(...args);
                            };
                            console.warn = (...args) => {
                                window.parent.postMessage({type: 'console', level: 'warn', content: args.join(' ')}, '*');
                                originalWarn(...args);
                            };
                            window.onerror = (msg, url, line) => {
                                window.parent.postMessage({type: 'console', level: 'error', content: msg + ' (line ' + line + ')'}, '*');
                            };
                        <\/script>
                    `;
                    content = content.replace('<head>', '<head>' + consoleBridge);

                    Object.keys(pages).forEach(filename => {
                        if (filename.endsWith('.css')) {
                            const cssContent = `<style data-filename="${filename}">${pages[filename].content}</style>`;
                            content = content.replace(new RegExp(`<link[^>]*href=["']\\.?/?${filename}["'][^>]*>`, 'g'), cssContent);
                        }
                        if (filename.endsWith('.js') && !content.includes('text/babel')) {
                            const jsContent = `<script data-filename="${filename}">${pages[filename].content}<\/script>`;
                            content = content.replace(new RegExp(`<script[^>]*src=["']\\.?/?${filename}["']([^>]*)><\/script>`, 'g'), jsContent);
                        }
                        if (filename.endsWith('.html')) {
                            const virtualUrl = `p.html?id=${pid}&u=${uid}&file=${filename}`;
                            content = content.replace(new RegExp(`href=["']\\.?/?${filename}["']`, 'g'), `href="${virtualUrl}"`);
                        }
                    });

                    const docBlob = frame.contentWindow.document;
                    docBlob.open();
                    docBlob.write(content);
                    docBlob.close();

                    frame.onload = () => {
                        document.getElementById('loader').classList.add('hidden');
                        frame.classList.remove('opacity-0');
                    };
                } else {
                    throw new Error("Project not found.");
                }
            } catch (e) {
                document.body.innerHTML = `<div style='color:white; padding:50px;'><h1>Preview Error</h1><p>${e.message}</p></div>`;
            }
        }

        window.addEventListener('load', loadSharedProject);
    </script>
</body>
</html>
