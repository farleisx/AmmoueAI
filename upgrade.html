<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Upgrade to Pro | Ammoue</title>
<link rel="icon" type="image/png" href="Gemini_Generated_Image_qry9pfqry9pfqry9.png">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
    .text-ammoue { color: #0d9488; }
    .bg-ammoue { background-color: #0d9488; }
</style>
</head>

<body class="antialiased min-h-screen flex flex-col items-center justify-center">

<div class="max-w-md w-full p-8 bg-white border border-gray-200 rounded-2xl shadow-xl text-center">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">
        Upgrade to <span class="text-ammoue">Pro</span>
    </h1>

    <p class="text-gray-700 mb-6">One-time payment. Lifetime access. ðŸš€</p>

    <!-- PAYPAL BUTTON -->
    <div id="paypal-button-container" class="mb-4"></div>

    <!-- STATUS -->
    <p id="status-message" class="mt-4 text-red-600 font-semibold"></p>
</div>

<!-- PayPal Sandbox SDK -->
<script src="https://www.paypal.com/sdk/js?client-id=AZV56OoDaOI2jTtex7U7x0Z_fsc9dm_98alHa81Y0okpIZkoZ-rVYhemDPsQ1FPvJOaF4Xt0dPHfprj1&currency=USD"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyAmnZ69YDcEFcmuXIhmGxDUSPULxpI-Bmg",
    authDomain: "ammoueai.firebaseapp.com",
    projectId: "ammoueai",
    storageBucket: "ammoueai.firebasestorage.app",
    messagingSenderId: "135818868149",
    appId: "1:135818868149:web:db9280baf9540a3339d5fc",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
const statusMessage = document.getElementById("status-message");

// Update plan in Firestore and redirect
async function setPlanToPro(uid) {
    await setDoc(doc(db, "users", uid), { plan: "pro" }, { merge: true });
    statusMessage.textContent = "Success! Redirectingâ€¦ ðŸš€";
    setTimeout(() => window.location.href = "dashboard.html", 1200);
}

// Monitor login state
onAuthStateChanged(auth, (user) => {
    currentUser = user;
    if (!user) statusMessage.textContent = "âš  Please log in to upgrade.";
});

// PayPal Smart Buttons
paypal.Buttons({
    createOrder: () => {
        if (!currentUser) {
            statusMessage.textContent = "âš  You must log in first.";
            return;
        }
        statusMessage.textContent = "Creating PayPal orderâ€¦";

        return fetch("/api/paypal-order", { method: "POST" })
            .then(res => res.json())
            .then(data => data.orderID)
            .catch(() => {
                statusMessage.textContent = "Error creating order. Backend may be missing.";
            });
    },

    onApprove: (data) => {
        if (!currentUser) {
            statusMessage.textContent = "âš  You must log in first.";
            return;
        }
        statusMessage.textContent = "Processing paymentâ€¦";

        return fetch(`/api/paypal-capture?orderID=${data.orderID}`, {
            headers: { "x-user-id": currentUser.uid }
        })
        .then(res => res.json())
        .then(async () => setPlanToPro(currentUser.uid))
        .catch(() => {
            statusMessage.textContent = "Payment verification failed!";
        });
    },

    onError: () => {
        statusMessage.textContent = "Something went wrong. Try again.";
    }

}).render("#paypal-button-container");

</script>
</body>
</html>
