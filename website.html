<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AmmoueAi - Build Your Vision</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="/fire_prompt.js" defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; overflow-x: hidden; }
        .preview-container iframe { width: 100%; height: 100%; border: none; background: white; }
        .cooldown-timer { color: #ef4444; font-weight: bold; }
        .hidden { display: none; }
        /* Smooth transitions for view modes */
        .transition-all { transition: all 0.3s ease-in-out; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <div id="authGuard" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl text-center">
            <h2 class="text-2xl font-bold mb-4">Authentication Required</h2>
            <p class="mb-6">Please log in to use the AmmoueAi Builder.</p>
            <button onclick="checkAuth()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Verify Session</button>
        </div>
    </div>

    <header class="border-b bg-white px-6 py-3 flex justify-between items-center z-40">
        <div class="flex items-center gap-4">
            <span class="text-xl font-bold text-blue-600">AmmoueAi</span>
            <div class="h-6 w-[1px] bg-gray-300"></div>
            <span class="text-sm text-gray-500" id="statusText">Ready to build</span>
        </div>
        
        <div class="flex items-center gap-3">
            <button id="viewToggle" onclick="toggleViewMode()" class="flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full border hover:bg-gray-200">
                <i class="fas fa-mobile-alt"></i>
                <span id="viewModeText" class="text-xs font-medium">Switch to Mobile</span>
            </button>
            <button id="publishBtn" onclick="handlePublish()" class="bg-blue-600 text-white px-4 py-1.5 rounded-lg text-sm font-medium hover:bg-blue-700 transition">
                <i class="fas fa-rocket mr-2"></i>Publish
            </button>
        </div>
    </header>

    <main id="mainContainer" class="flex flex-1 overflow-hidden transition-all">
        
        <aside id="sidebar" class="w-80 border-r bg-white flex flex-col p-4 gap-6 overflow-y-auto">
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Describe Your Website</label>
                <textarea id="promptInput" rows="5" class="w-full border rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="e.g. A modern landing page for a coffee shop with a hero section and gallery..."></textarea>
            </div>

            <div class="space-y-2">
                <label class="block text-sm font-semibold text-gray-700">Attachments</label>
                <div id="imagePreviewContainer" class="flex flex-wrap gap-2 mb-2"></div>
                <label class="cursor-pointer flex items-center justify-center w-full border-2 border-dashed border-gray-300 rounded-lg p-4 hover:border-blue-500">
                    <input type="file" id="imageInput" class="hidden" accept="image/*" multiple onchange="handleImageUpload(event)">
                    <span class="text-xs text-gray-500"><i class="fas fa-plus mr-1"></i> Add Images</span>
                </label>
            </div>

            <div class="space-y-3 pt-4 border-t">
                <button id="generateBtn" onclick="handleGenerate()" class="w-full bg-black text-white py-3 rounded-xl font-medium hover:opacity-90 disabled:bg-gray-400">
                    Generate Website
                </button>
                <button id="refineBtn" onclick="handleRefine()" class="w-full border border-gray-300 py-3 rounded-xl font-medium hover:bg-gray-50 disabled:opacity-50">
                    Refine Selection
                </button>
                <div id="cooldownDisplay" class="text-center text-xs text-red-500 font-bold hidden">
                    Cooldown: <span id="timer">60</span>s
                </div>
            </div>

            <div class="mt-auto grid grid-cols-2 gap-2 pt-4">
                <button onclick="copyContent()" class="text-xs border p-2 rounded hover:bg-gray-50"><i class="fas fa-copy mr-1"></i> Copy</button>
                <button onclick="downloadContent()" class="text-xs border p-2 rounded hover:bg-gray-50"><i class="fas fa-download mr-1"></i> Download</button>
            </div>
        </aside>

        <section id="previewArea" class="flex-1 bg-gray-100 p-4 flex flex-col relative">
            <div class="bg-white rounded-xl shadow-sm border h-full overflow-hidden flex flex-col">
                <div class="bg-gray-50 border-b px-4 py-2 flex justify-between items-center">
                    <div class="flex gap-1.5">
                        <div class="w-3 h-3 rounded-full bg-red-400"></div>
                        <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
                        <div class="w-3 h-3 rounded-full bg-green-400"></div>
                    </div>
                    <span class="text-xs text-gray-400 font-mono">live-preview.ammoue.ai</span>
                    <div id="deployStatus" class="text-[10px] font-bold uppercase text-gray-400">Not Deployed</div>
                </div>
                <div class="preview-container flex-1">
                    <iframe id="outputFrame"></iframe>
                </div>
            </div>
        </section>

    </main>

    <script>
        // State Management
        let isMobileMode = false;
        let isCooldown = false;
        let currentHTML = "";
        let uploadedImages = [];

        // UI Element Selectors
        const mainContainer = document.getElementById('mainContainer');
        const sidebar = document.getElementById('sidebar');
        const previewArea = document.getElementById('previewArea');
        const viewModeText = document.getElementById('viewModeText');
        const promptInput = document.getElementById('promptInput');
        const outputFrame = document.getElementById('outputFrame');
        const timerDisplay = document.getElementById('timer');
        const cooldownBox = document.getElementById('cooldownDisplay');

        // 1. View Mode Toggle (Mobile vs Lovable Desktop)
        function toggleViewMode() {
            isMobileMode = !isMobileMode;
            if (isMobileMode) {
                // Switch to Center ChatGPT style
                mainContainer.classList.add('justify-center', 'items-center', 'p-8');
                sidebar.className = "w-full max-w-2xl bg-white shadow-xl rounded-2xl p-6 border flex flex-col gap-4";
                previewArea.classList.add('hidden');
                viewModeText.innerText = "Switch to Desktop View";
            } else {
                // Switch back to Lovable Split style
                mainContainer.classList.remove('justify-center', 'items-center', 'p-8');
                sidebar.className = "w-80 border-r bg-white flex flex-col p-4 gap-6 overflow-y-auto";
                previewArea.classList.remove('hidden');
                viewModeText.innerText = "Switch to Mobile View";
            }
        }

        // 2. Image Handling
        function handleImageUpload(event) {
            const files = event.target.files;
            for (let file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const id = Date.now() + Math.random();
                    uploadedImages.push({ id, data: e.target.result });
                    renderImages();
                };
                reader.readAsDataURL(file);
            }
        }

        function removeImage(id) {
            uploadedImages = uploadedImages.filter(img => img.id !== id);
            renderImages();
        }

        function renderImages() {
            const container = document.getElementById('imagePreviewContainer');
            container.innerHTML = uploadedImages.map(img => `
                <div class="relative w-16 h-16 border rounded overflow-hidden">
                    <img src="${img.data}" class="object-cover w-full h-full">
                    <button onclick="removeImage(${img.id})" class="absolute top-0 right-0 bg-red-500 text-white text-[10px] p-1">X</button>
                </div>
            `).join('');
        }

        // 3. API Connections & Streaming Logic
        async function handleGenerate() {
            if (isCooldown) return;
            const prompt = promptInput.value;
            if (!prompt) return alert("Please describe your website");

            startCooldown();
            currentHTML = "";
            updateStatus("Generating code...");

            try {
                // Connect to /api/generate.js
                const response = await fetch('/api/generate.js', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, images: uploadedImages })
                });

                // Simulating Streamed Response in 50-character chunks
                const fullResponse = "<html><body><h1 style='text-align:center; margin-top:50px;'>AmmoueAi Generated Site</h1><p style='padding:20px;'>" + prompt + "</p></body></html>"; 
                
                streamToPreview(fullResponse);

            } catch (err) {
                console.error("API Error:", err);
                // Fallback for demo purposes
                streamToPreview("<!DOCTYPE html><html><body style='font-family:sans-serif; padding:40px;'><h1>Welcome to your " + prompt + "</h1><p>This is a live preview generated by AmmoueAi.</p></body></html>");
            }
        }

        function streamToPreview(text) {
            let index = 0;
            const chunkSize = 50;

            const interval = setInterval(() => {
                if (index < text.length) {
                    currentHTML += text.slice(index, index + chunkSize);
                    index += chunkSize;
                    
                    // Live Update Preview
                    const doc = outputFrame.contentDocument || outputFrame.contentWindow.document;
                    doc.open();
                    doc.write(currentHTML);
                    doc.close();
                } else {
                    clearInterval(interval);
                    updateStatus("Generation Complete");
                    autoSave();
                }
            }, 100); // 100ms delay between chunks for visibility
        }

        // 4. Cooldown Logic
        function startCooldown() {
            isCooldown = true;
            document.getElementById('generateBtn').disabled = true;
            cooldownBox.classList.remove('hidden');
            let timeLeft = 60;
            
            const timer = setInterval(() => {
                timeLeft--;
                timerDisplay.innerText = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    isCooldown = false;
                    document.getElementById('generateBtn').disabled = false;
                    cooldownBox.classList.add('hidden');
                }
            }, 1000);
        }

        // 5. Utility Actions (Copy, Download, Deploy)
        function copyContent() {
            navigator.clipboard.writeText(currentHTML);
            alert("Code copied to clipboard!");
        }

        function downloadContent() {
            const blob = new Blob([currentHTML], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'ammoue-website.html';
            a.click();
        }

        async function handlePublish() {
            updateStatus("Deploying to Vercel...");
            try {
                const res = await fetch('/api/deploy.js', {
                    method: 'POST',
                    body: JSON.stringify({ html: currentHTML })
                });
                // Start checking status via api/CheckDeploymentStatus.js
                pollDeployment();
            } catch (e) {
                alert("Deployment failed. Ensure deploy.js is configured.");
            }
        }

        function pollDeployment() {
            const statusLabel = document.getElementById('deployStatus');
            statusLabel.innerText = "Deploying...";
            statusLabel.className = "text-[10px] font-bold text-yellow-500";
            
            setTimeout(() => {
                statusLabel.innerText = "Live on Vercel";
                statusLabel.className = "text-[10px] font-bold text-green-500";
            }, 5000);
        }

        function autoSave() {
            console.log("Project saved to User Dashboard.");
            // Logic to connect to fire_prompt.js and Firebase
        }

        function updateStatus(text) {
            document.getElementById('statusText').innerText = text;
        }

        function checkAuth() {
            // Check Firebase / Session
            document.getElementById('authGuard').classList.add('hidden');
        }
    </script>
</body>
</html>
